---
phase: 04-profiles-connections
plan: 04
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - app/user/[username].tsx
  - lib/relay/__generated__/userProfileQuery.graphql.ts
autonomous: true

must_haves:
  truths:
    - "User can view another user's profile by username"
    - "Other user's profile shows their posts"
    - "Profile shows follower and following counts"
    - "Follow button appears (not Edit Profile) for other users"
    - "Tapping avatar in posts navigates to user profile"
  artifacts:
    - path: "app/user/[username].tsx"
      provides: "Dynamic user profile screen by username"
      exports: ["default"]
  key_links:
    - from: "app/user/[username].tsx"
      to: "userByUsername query"
      via: "useLazyLoadQuery"
      pattern: "userByUsername.*username"
    - from: "app/user/[username].tsx"
      to: "components/profile/profile-header.tsx"
      via: "ProfileHeader import"
      pattern: "import.*ProfileHeader"
    - from: "components/verse/reflection-item.tsx"
      to: "app/user/[username].tsx"
      via: "navigation on avatar tap"
      pattern: "router\\.push.*user"
---

<objective>
Create user profile screen for viewing other users' profiles.

Purpose: Implements PROF-03 (view other users) and PROF-04 (see follower/following counts)
Output: Dynamic profile screen accessible via /user/[username]
</objective>

<execution_context>
@/Users/jay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-profiles-connections/04-CONTEXT.md
@.planning/phases/04-profiles-connections/04-RESEARCH.md
@.planning/phases/04-profiles-connections/04-02-SUMMARY.md
@selah-web/src/client-pages/user-profile-page.tsx (query pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user profile screen with GraphQL query</name>
  <files>app/user/[username].tsx</files>
  <action>
Create dynamic route for viewing any user's profile:

**File structure**: Create `app/user/[username].tsx` (expo-router dynamic route)

**GraphQL query** (matching selah-web userProfilePageQuery):
```graphql
query userProfileQuery($username: String!) {
  userByUsername(username: $username) {
    id
    username
    name
    bio
    image {
      url
    }
    followerCount
    followingCount
    followedAt  # null if not following, timestamp if following
    ...profilePostsListFragment
  }
}
```

**Screen implementation**:
```typescript
import { useLocalSearchParams } from 'expo-router';

export default function UserProfileScreen() {
  const { username } = useLocalSearchParams<{ username: string }>();
  const { session } = useSession();

  const data = useLazyLoadQuery<userProfileQuery>(query, { username });
  const user = data.userByUsername;

  if (!user) {
    return <NotFoundScreen message="User not found" />;
  }

  const isOwnProfile = session?.user?.id === user.id;

  return (
    <SafeAreaView>
      <ScrollView>
        <ProfileHeader
          name={user.name}
          username={user.username}
          bio={user.bio}
          imageUrl={user.image?.url}
        >
          {isOwnProfile ? (
            <Button onPress={() => router.push('/user-edit')}>
              <Text>Edit Profile</Text>
            </Button>
          ) : (
            <FollowButton userRef={user} />  // Placeholder, implemented in 04-05
          )}
        </ProfileHeader>

        <ProfileStatsRow
          userId={user.id}
          followerCount={user.followerCount ?? 0}
          followingCount={user.followingCount ?? 0}
        />

        <ProfilePostsList
          userRef={user}
          currentUserId={session?.user?.id}
          onLike={handleLike}
          onUnlike={handleUnlike}
          onDelete={handleDelete}
        />
      </ScrollView>
    </SafeAreaView>
  );
}
```

**Navigation header**:
- Back button (default from Stack)
- Title: user's display name or @username
- Optional: more menu (share profile, etc.) - can add later

Wrap in Suspense with ProfileSkeleton fallback.
  </action>
  <verify>`npx relay-compiler && npx tsc --noEmit`</verify>
  <done>User profile screen renders profile data from userByUsername query</done>
</task>

<task type="auto">
  <name>Task 2: Add post interactions and own-profile detection</name>
  <files>app/user/[username].tsx</files>
  <action>
Add like/unlike/delete functionality:

**Reuse mutations from profile tab**:
```typescript
const [commitLike] = useMutation(IdPostLikeMutation);
const [commitUnlike] = useMutation(IdPostUnlikeMutation);
const [commitDelete] = useMutation(IdPostDeleteMutation);
```

**Handlers** (same as profile.tsx):
```typescript
const handleLike = (postId: string) => {
  Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
  commitLike({
    variables: { postId },
    optimisticUpdater: (store) => {
      const post = store.get(postId);
      if (post) {
        post.setValue((post.getValue('likesCount') as number) + 1, 'likesCount');
        post.setValue(new Date().toISOString(), 'likedAt');
      }
    },
  });
};
// Similar for handleUnlike, handleDelete
```

**Own profile detection**:
- Compare session.user.id with user.id
- If own profile: show "Edit Profile" button
- If other user: show placeholder button (FollowButton in 04-05)

**Placeholder FollowButton** (until 04-05):
```typescript
// Temporary placeholder
function FollowButtonPlaceholder({ followedAt }: { followedAt: string | null }) {
  const isFollowing = !!followedAt;
  return (
    <Button variant={isFollowing ? 'outline' : 'default'} disabled>
      <Text>{isFollowing ? 'Following' : 'Follow'}</Text>
    </Button>
  );
}
```

Show placeholder until follow mutation is wired in 04-05.
  </action>
  <verify>View another user's profile, see Follow button (disabled placeholder)</verify>
  <done>Other user profiles show Follow button; own profile shows Edit Profile</done>
</task>

<task type="auto">
  <name>Task 3: Add navigation from posts to user profiles</name>
  <files>components/verse/reflection-item.tsx</files>
  <action>
Make avatar and username tappable to navigate to user profile:

**Modify ReflectionItem** (around lines 344-390):

Add navigation handlers:
```typescript
const handleUserPress = useCallback(() => {
  if (user.username) {
    router.push(`/user/${user.username}`);
  }
}, [user.username, router]);
```

**Wrap avatar in Pressable**:
```typescript
{/* Avatar - now tappable */}
<Pressable onPress={handleUserPress} style={styles.avatarContainer}>
  {user.image?.url ? (
    <Image ... />
  ) : (
    <View ... />
  )}
</Pressable>
```

**Make name/username tappable**:
```typescript
<Pressable onPress={handleUserPress} style={styles.headerLeft}>
  <Text style={[styles.displayName, { color: colors.text }]} numberOfLines={1}>
    {user.name || user.username || "Anonymous"}
  </Text>
  <Text style={[styles.username, { color: colors.textMuted }]} numberOfLines={1}>
    @{user.username || "user"}
  </Text>
  <Text style={[styles.dot, { color: colors.textMuted }]}>Â·</Text>
  <Text style={[styles.time, { color: colors.textMuted }]}>
    {formattedDate}
  </Text>
</Pressable>
```

Keep the card press navigation to post detail separate from user press.
  </action>
  <verify>Tap avatar or name in any post, navigates to /user/[username]</verify>
  <done>Avatar and username in posts navigate to user profile</done>
</task>

</tasks>

<verification>
1. `npx relay-compiler` generates userProfileQuery types
2. `npx tsc --noEmit` passes
3. Navigate to /user/testuser, profile renders with posts
4. Own profile shows Edit Profile button
5. Other user shows Follow button (placeholder)
6. Tap avatar in any post, navigates to user profile
7. Posts on profile show like/unlike functionality
</verification>

<success_criteria>
- /user/[username] route renders any user's profile
- Profile header shows name, username, bio, avatar
- Stats row shows follower/following counts
- Own profile detection works correctly
- Navigation from posts to profiles works
- Post interactions work on profile screen
</success_criteria>

<output>
After completion, create `.planning/phases/04-profiles-connections/04-04-SUMMARY.md`
</output>
