---
phase: 04-profiles-connections
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/(tabs)/profile.tsx
  - components/profile/profile-posts-list.tsx
  - lib/relay/__generated__/profilePostsListFragment.graphql.ts
  - lib/relay/__generated__/ownProfileQuery.graphql.ts
autonomous: true

must_haves:
  truths:
    - "User can view their own profile with bio"
    - "User can see list of their posts on profile"
    - "Profile shows follower and following counts"
    - "Edit Profile button appears on own profile"
    - "Posts load with pagination (infinite scroll)"
  artifacts:
    - path: "app/(tabs)/profile.tsx"
      provides: "Own profile tab screen with Relay query"
      exports: ["default"]
    - path: "components/profile/profile-posts-list.tsx"
      provides: "User's posts with FlashList and pagination"
      exports: ["ProfilePostsList"]
  key_links:
    - from: "app/(tabs)/profile.tsx"
      to: "components/profile/profile-header.tsx"
      via: "ProfileHeader import"
      pattern: "import.*ProfileHeader"
    - from: "app/(tabs)/profile.tsx"
      to: "components/profile/profile-posts-list.tsx"
      via: "ProfilePostsList import"
      pattern: "import.*ProfilePostsList"
    - from: "components/profile/profile-posts-list.tsx"
      to: "usePaginationFragment"
      via: "Relay pagination"
      pattern: "usePaginationFragment"
---

<objective>
Transform profile tab to show user's profile with their posts.

Purpose: Implements PROF-01 (view own profile with bio and posts)
Output: Working own profile screen with post list
</objective>

<execution_context>
@/Users/jay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-profiles-connections/04-CONTEXT.md
@.planning/phases/04-profiles-connections/04-RESEARCH.md
@.planning/phases/04-profiles-connections/04-01-SUMMARY.md
@components/verse/posts-list.tsx (pagination pattern)
@selah-web/src/client-pages/user-profile-page.tsx (query structure)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProfilePostsList component with Relay pagination</name>
  <files>components/profile/profile-posts-list.tsx</files>
  <action>
Create user posts list following the postsListFragment pattern:

```typescript
interface ProfilePostsListProps {
  userRef: profilePostsListFragment$key;
  currentUserId?: string | null;
  onLike: (id: string) => void;
  onUnlike: (id: string) => void;
  onDelete: (id: string) => void;
}
```

GraphQL fragment (adapt from selah-web userVersePostList):
```graphql
fragment profilePostsListFragment on User
@argumentDefinitions(
  count: { type: "Int", defaultValue: 20 }
  cursor: { type: "String" }
)
@refetchable(queryName: "profilePostsListPaginationQuery") {
  posts(first: $count, after: $cursor)
  @connection(key: "profilePostsList_posts") {
    edges {
      node {
        id
        content
        createdAt
        likesCount
        childPostsCount
        likedAt
        user {
          id
          name
          username
          image { url }
        }
        images {
          url
          width
          height
        }
        poll {
          id
          totalVotes
          isExpired
          userVote { id text }
          options {
            id
            text
            voteCount
            votePercentage
          }
        }
        verse {
          id
          book
          chapter
          verse
          text
          translation
        }
      }
    }
  }
}
```

Implementation:
- Use usePaginationFragment hook
- Use FlashList for virtualized rendering
- Render ReflectionItem for each post (reuse from verse screen)
- Add verse reference display above each post (book chapter:verse)
- Implement onEndReached to loadNext for infinite scroll
- Show empty state when no posts: "No posts yet"

Use useColors hook for theming.
  </action>
  <verify>Run `npx relay-compiler` to generate types, then `npx tsc --noEmit`</verify>
  <done>ProfilePostsList renders user's posts with pagination and verse references</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite profile.tsx as own profile screen</name>
  <files>app/(tabs)/profile.tsx</files>
  <action>
Transform the current settings-style profile into a proper profile view:

GraphQL query for own profile:
```graphql
query ownProfileQuery {
  me {
    id
    name
    username
    bio
    image { url }
    followerCount
    followingCount
    ...profilePostsListFragment
  }
}
```

Screen structure:
1. **Header area** (inside ScrollView/FlashList header):
   - ProfileHeader with avatar, name, username, bio
   - ProfileStatsRow with follower/following counts
   - "Edit Profile" Button that navigates to /user-edit

2. **Posts section**:
   - ProfilePostsList component
   - Handles own pagination

3. **Keep Bible utilities section** from current profile.tsx:
   - Search Bible, Bookmarks, Notes links
   - Move to bottom or separate "Settings" tab later

4. **Keep sign out** for authenticated users

State handling:
- Use Suspense with ProfileSkeleton fallback
- If not authenticated, show sign-in prompt (keep existing logic)
- Like/Unlike/Delete mutations for own posts

Use useLazyLoadQuery for the profile query.
Wrap in Suspense boundary at layout level or use ErrorBoundary.
  </action>
  <verify>App loads profile tab: authenticated user sees their profile, posts list renders</verify>
  <done>Profile tab shows own profile with header, stats, posts list, and edit button</done>
</task>

<task type="auto">
  <name>Task 3: Add like/unlike/delete mutations for profile posts</name>
  <files>app/(tabs)/profile.tsx</files>
  <action>
Wire up post interactions following existing patterns from verse/[id].tsx:

Import existing mutations:
- IdPostLikeMutation for liking posts
- IdPostUnlikeMutation for unliking posts
- IdPostDeleteMutation for deleting own posts

Create handlers:
```typescript
const [commitLike] = useMutation(IdPostLikeMutation);
const [commitUnlike] = useMutation(IdPostUnlikeMutation);
const [commitDelete] = useMutation(IdPostDeleteMutation);

const handleLike = (postId: string) => {
  commitLike({
    variables: { postId },
    optimisticUpdater: (store) => {
      const post = store.get(postId);
      if (post) {
        post.setValue((post.getValue('likesCount') as number) + 1, 'likesCount');
        post.setValue(new Date().toISOString(), 'likedAt');
      }
    },
  });
};
```

Pass handlers to ProfilePostsList: onLike, onUnlike, onDelete.

Add haptic feedback on interactions using expo-haptics.
  </action>
  <verify>Like a post on profile, see count increment immediately (optimistic update)</verify>
  <done>Post interactions work with optimistic updates on own profile</done>
</task>

</tasks>

<verification>
1. `npx relay-compiler` generates new fragment and query types
2. `npx tsc --noEmit` passes
3. Profile tab shows authenticated user's profile with posts
4. Tapping Edit Profile navigates (route may not exist yet - ok)
5. Posts render with verse references
6. Scrolling loads more posts (infinite scroll)
7. Like/unlike updates counts immediately
</verification>

<success_criteria>
- Own profile displays bio, avatar, follower/following counts
- Posts list shows user's posts with pagination
- Edit Profile button present and tappable
- Like/unlike/delete work with optimistic updates
- Unauthenticated users see sign-in prompt
</success_criteria>

<output>
After completion, create `.planning/phases/04-profiles-connections/04-02-SUMMARY.md`
</output>
