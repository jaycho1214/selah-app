---
phase: 04-profiles-connections
plan: 05
type: execute
wave: 4
depends_on: ["04-04"]
files_modified:
  - components/user/follow-button.tsx
  - lib/relay/__generated__/FollowButton_user.graphql.ts
  - lib/relay/__generated__/FollowButtonMutation.graphql.ts
  - app/user/[username].tsx
autonomous: true

must_haves:
  truths:
    - "User can follow another user"
    - "User can unfollow a user they follow"
    - "Follow button shows loading state during request"
    - "Follower count increments immediately on follow (optimistic)"
    - "Follower count decrements immediately on unfollow (optimistic)"
    - "Users cannot follow themselves"
  artifacts:
    - path: "components/user/follow-button.tsx"
      provides: "Follow/Unfollow button with loading state and optimistic updates"
      exports: ["FollowButton"]
  key_links:
    - from: "components/user/follow-button.tsx"
      to: "userFollow/userUnfollow mutations"
      via: "useMutation"
      pattern: "userFollow|userUnfollow"
    - from: "components/user/follow-button.tsx"
      to: "optimisticUpdater"
      via: "Relay store update"
      pattern: "optimisticUpdater"
    - from: "app/user/[username].tsx"
      to: "components/user/follow-button.tsx"
      via: "FollowButton import"
      pattern: "import.*FollowButton"
---

<objective>
Implement follow/unfollow functionality with optimistic updates.

Purpose: Implements CONN-01 (follow users) and CONN-02 (unfollow users)
Output: Working follow button with immediate UI feedback
</objective>

<execution_context>
@/Users/jay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-profiles-connections/04-CONTEXT.md
@.planning/phases/04-profiles-connections/04-RESEARCH.md
@.planning/phases/04-profiles-connections/04-04-SUMMARY.md
@selah-web/src/components/user/user-follow-button.tsx (exact pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FollowButton component with fragment</name>
  <files>components/user/follow-button.tsx</files>
  <action>
Create follow button matching selah-web pattern exactly:

**Fragment** (from selah-web user-follow-button.tsx):
```graphql
fragment FollowButton_user on User {
  id
  followedAt
  followerCount
}
```

**Component**:
```typescript
import { ActivityIndicator, Pressable, StyleSheet } from 'react-native';
import { useFragment, useMutation } from 'react-relay';
import { graphql } from 'relay-runtime';
import * as Haptics from 'expo-haptics';

import { Text } from '@/components/ui/text';
import { useColors } from '@/hooks/use-colors';
import type { FollowButton_user$key } from '@/lib/relay/__generated__/FollowButton_user.graphql';
import type { FollowButtonMutation } from '@/lib/relay/__generated__/FollowButtonMutation.graphql';

interface FollowButtonProps {
  userRef: FollowButton_user$key;
}

export function FollowButton({ userRef }: FollowButtonProps) {
  const colors = useColors();
  const data = useFragment(fragment, userRef);
  const [commit, isMutationInFlight] = useMutation<FollowButtonMutation>(mutation);

  const isFollowing = !!data?.followedAt;

  const handlePress = () => {
    if (!data?.id) return;

    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);

    commit({
      variables: {
        userId: data.id,
        value: !isFollowing,  // true = follow, false = unfollow
      },
      optimisticUpdater: (store) => {
        const user = store.get(data.id);
        if (user) {
          // Toggle followedAt
          user.setValue(
            isFollowing ? null : new Date().toISOString(),
            'followedAt'
          );
          // Update follower count
          const currentCount = (user.getValue('followerCount') as number) ?? 0;
          user.setValue(
            isFollowing ? currentCount - 1 : currentCount + 1,
            'followerCount'
          );
        }
      },
    });
  };

  return (
    <Pressable
      onPress={handlePress}
      disabled={isMutationInFlight}
      style={[
        styles.button,
        isFollowing ? styles.followingButton : styles.followButton,
        { borderColor: colors.border },
        isMutationInFlight && styles.disabledButton,
      ]}
    >
      {isMutationInFlight ? (
        <ActivityIndicator
          size="small"
          color={isFollowing ? colors.text : '#fff'}
        />
      ) : (
        <Text
          style={[
            styles.buttonText,
            isFollowing
              ? { color: colors.text }
              : { color: '#fff' },
          ]}
        >
          {isFollowing ? 'Following' : 'Follow'}
        </Text>
      )}
    </Pressable>
  );
}

const styles = StyleSheet.create({
  button: {
    paddingHorizontal: 16,
    paddingVertical: 8,
    borderRadius: 20,
    minWidth: 100,
    alignItems: 'center',
    justifyContent: 'center',
  },
  followButton: {
    backgroundColor: '#000', // Or use accent color
  },
  followingButton: {
    backgroundColor: 'transparent',
    borderWidth: 1,
  },
  disabledButton: {
    opacity: 0.7,
  },
  buttonText: {
    fontSize: 14,
    fontWeight: '600',
  },
});
```
  </action>
  <verify>`npx relay-compiler && npx tsc --noEmit`</verify>
  <done>FollowButton component created with fragment and styling</done>
</task>

<task type="auto">
  <name>Task 2: Add follow/unfollow mutation</name>
  <files>components/user/follow-button.tsx</files>
  <action>
Add mutation matching selah-web pattern:

**Mutation** (using @include/@skip for conditional execution):
```graphql
mutation FollowButtonMutation($userId: ID!, $value: Boolean!) {
  userFollow(userId: $userId) @include(if: $value) {
    user {
      id
      followedAt
      followerCount
    }
  }
  userUnfollow(userId: $userId) @skip(if: $value) {
    user {
      id
      followedAt
      followerCount
    }
  }
}
```

This pattern:
- When `value: true` (follow): executes `userFollow`, skips `userUnfollow`
- When `value: false` (unfollow): skips `userFollow`, executes `userUnfollow`

The optimisticUpdater provides immediate feedback.
The mutation response updates the Relay store with server state.

**Error handling**:
```typescript
commit({
  variables: { userId: data.id, value: !isFollowing },
  optimisticUpdater: (store) => { ... },
  onError: (error) => {
    // Optimistic update auto-rolls back
    Haptics.notificationAsync(Haptics.NotificationFeedbackType.Error);
    console.error('Follow/unfollow failed:', error);
  },
});
```

No confirmation dialog for unfollow (CONTEXT decision: immediate unfollow).
  </action>
  <verify>Relay compiler generates mutation types</verify>
  <done>Follow/unfollow mutation works with optimistic updates and rollback</done>
</task>

<task type="auto">
  <name>Task 3: Integrate FollowButton into user profile screen</name>
  <files>app/user/[username].tsx</files>
  <action>
Replace placeholder with real FollowButton:

**Update query to include FollowButton fragment**:
```graphql
query userProfileQuery($username: String!) {
  userByUsername(username: $username) {
    id
    username
    name
    bio
    image { url }
    followerCount
    followingCount
    followedAt
    ...FollowButton_user
    ...profilePostsListFragment
  }
}
```

**Update profile header children**:
```typescript
<ProfileHeader
  name={user.name}
  username={user.username}
  bio={user.bio}
  imageUrl={user.image?.url}
>
  {isOwnProfile ? (
    <Button onPress={() => router.push('/user-edit')}>
      <Text>Edit Profile</Text>
    </Button>
  ) : session?.user ? (
    // Only show Follow button if logged in
    <FollowButton userRef={user} />
  ) : (
    // Prompt sign in for anonymous users
    <Button onPress={presentSignIn}>
      <Text>Sign in to Follow</Text>
    </Button>
  )}
</ProfileHeader>
```

**Handle "users cannot follow themselves"**:
- This is handled by the isOwnProfile check
- Backend should also validate, but UI prevents the action

Import FollowButton and add to component.
  </action>
  <verify>View other user profile, tap Follow, see count increment, button changes to Following</verify>
  <done>FollowButton integrated into profile screen with proper conditionals</done>
</task>

</tasks>

<verification>
1. `npx relay-compiler` generates fragment and mutation types
2. `npx tsc --noEmit` passes
3. View another user's profile (not own)
4. Tap Follow button, see:
   - Button shows spinner
   - Follower count increments immediately
   - Button text changes to "Following"
5. Tap Following button, see:
   - Button shows spinner
   - Follower count decrements immediately
   - Button text changes to "Follow"
6. Rapid taps disabled while mutation in flight
7. Own profile shows Edit Profile, not Follow button
8. Anonymous users see "Sign in to Follow"
</verification>

<success_criteria>
- FollowButton shows correct state (Follow/Following)
- Tap triggers mutation with optimistic update
- Follower count updates immediately
- Button disabled during mutation (prevents double-tap)
- No confirmation on unfollow (immediate)
- Proper handling for own profile and anonymous users
</success_criteria>

<output>
After completion, create `.planning/phases/04-profiles-connections/04-05-SUMMARY.md`
</output>
