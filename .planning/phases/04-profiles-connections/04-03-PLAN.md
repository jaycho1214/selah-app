---
phase: 04-profiles-connections
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/user-edit.tsx
  - lib/relay/__generated__/userEditQuery.graphql.ts
  - lib/relay/__generated__/userUpdateMutation.graphql.ts
autonomous: true

must_haves:
  truths:
    - "User can edit their name and see it persist"
    - "User can edit their bio and see it persist"
    - "User can change their avatar via action sheet"
    - "Cancel button discards changes without saving"
    - "Done button saves all changes at once"
    - "Confirmation dialog appears when leaving with unsaved changes"
  artifacts:
    - path: "app/user-edit.tsx"
      provides: "Edit profile screen with form and avatar upload"
      exports: ["default"]
  key_links:
    - from: "app/user-edit.tsx"
      to: "expo-image-picker"
      via: "launchCameraAsync/launchImageLibraryAsync"
      pattern: "ImagePicker\\.(launchCamera|launchImageLibrary)"
    - from: "app/user-edit.tsx"
      to: "/api/upload"
      via: "fetch POST for image upload"
      pattern: "fetch.*upload"
    - from: "app/user-edit.tsx"
      to: "userUpdateMutation"
      via: "useMutation for saving"
      pattern: "useMutation.*userUpdate"
---

<objective>
Create edit profile screen with avatar upload and form fields.

Purpose: Implements PROF-02 (edit name, bio, avatar with persistence)
Output: Functional edit profile screen with save/cancel/discard-changes flow
</objective>

<execution_context>
@/Users/jay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-profiles-connections/04-CONTEXT.md
@.planning/phases/04-profiles-connections/04-RESEARCH.md
@.planning/phases/04-profiles-connections/04-01-SUMMARY.md
@selah-web/src/components/user/user-edit-profile-dialog.tsx (mutation pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create edit profile screen with form state</name>
  <files>app/user-edit.tsx</files>
  <action>
Create push-navigated edit profile screen:

**Route**: `/user-edit` (Stack.Screen, not tab)

**Query for initial data**:
```graphql
query userEditQuery {
  me {
    id
    name
    username
    bio
    image {
      id
      url
    }
  }
}
```

**Form state** using useState:
```typescript
const [name, setName] = useState(data.me.name ?? '');
const [bio, setBio] = useState(data.me.bio ?? '');
const [imageId, setImageId] = useState<string | null>(data.me.image?.id ?? null);
const [imageUrl, setImageUrl] = useState<string | null>(data.me.image?.url ?? null);
const [isUploading, setIsUploading] = useState(false);
```

**Track unsaved changes**:
```typescript
const hasChanges = useMemo(() => {
  return name !== (data.me.name ?? '') ||
         bio !== (data.me.bio ?? '') ||
         imageId !== (data.me.image?.id ?? null);
}, [name, bio, imageId, data]);
```

**Screen layout**:
- Stack.Screen with custom header: Cancel (left), "Edit Profile" (title), Done (right)
- UserAvatar at top (tappable to change)
- TextInput for Name (required, max 30 chars)
- TextInput for Bio (optional, max 200 chars, multiline)
- Character count display below bio

**Header buttons**:
- Cancel: calls handleCancel (see Task 2)
- Done: disabled when !hasChanges || isSaving, shows ActivityIndicator when saving

Use NativeWind for styling. Form inputs with border, rounded corners, padding.
  </action>
  <verify>`npx relay-compiler && npx tsc --noEmit`</verify>
  <done>Edit profile screen renders with form fields pre-populated from query</done>
</task>

<task type="auto">
  <name>Task 2: Implement avatar change with action sheet and upload</name>
  <files>app/user-edit.tsx</files>
  <action>
Add avatar change functionality:

**Action sheet** (CONTEXT decision: ActionSheetIOS on iOS, Alert.alert on Android):

```typescript
import * as ImagePicker from 'expo-image-picker';
import { ActionSheetIOS, Platform, Alert, ActivityIndicator } from 'react-native';

const showAvatarOptions = () => {
  const options = ['Take Photo', 'Choose from Library', 'Remove Photo', 'Cancel'];

  if (Platform.OS === 'ios') {
    ActionSheetIOS.showActionSheetWithOptions(
      {
        options,
        cancelButtonIndex: 3,
        destructiveButtonIndex: 2,
      },
      handleAvatarAction
    );
  } else {
    Alert.alert('Change Photo', undefined, [
      { text: 'Take Photo', onPress: () => handleAvatarAction(0) },
      { text: 'Choose from Library', onPress: () => handleAvatarAction(1) },
      { text: 'Remove Photo', onPress: () => handleAvatarAction(2), style: 'destructive' },
      { text: 'Cancel', style: 'cancel' },
    ]);
  }
};

const handleAvatarAction = async (buttonIndex: number) => {
  if (buttonIndex === 0) await launchCamera();
  if (buttonIndex === 1) await launchLibrary();
  if (buttonIndex === 2) removeAvatar();
};
```

**Camera/Library launch**:
```typescript
const launchCamera = async () => {
  const { status } = await ImagePicker.requestCameraPermissionsAsync();
  if (status !== 'granted') {
    Alert.alert('Permission Denied', 'Camera access is needed to take photos');
    return;
  }
  const result = await ImagePicker.launchCameraAsync({
    allowsEditing: true,
    aspect: [1, 1],
    quality: 0.8,
  });
  if (!result.canceled) {
    await uploadImage(result.assets[0]);
  }
};

const launchLibrary = async () => {
  const result = await ImagePicker.launchImageLibraryAsync({
    allowsEditing: true,
    aspect: [1, 1],
    quality: 0.8,
    mediaTypes: ImagePicker.MediaTypeOptions.Images,
  });
  if (!result.canceled) {
    await uploadImage(result.assets[0]);
  }
};
```

**Upload to /api/upload**:
```typescript
const uploadImage = async (asset: ImagePicker.ImagePickerAsset) => {
  setIsUploading(true);
  try {
    const formData = new FormData();
    formData.append('file', {
      uri: asset.uri,
      type: 'image/jpeg',
      name: 'avatar.jpg',
    } as any);

    const response = await fetch(`${API_URL}/api/upload`, {
      method: 'POST',
      body: formData,
      headers: {
        'Authorization': `Bearer ${session?.accessToken}`,
      },
    });

    const data = await response.json();
    if (data.ok) {
      setImageId(data.data.id);
      setImageUrl(data.data.url);
    }
  } finally {
    setIsUploading(false);
  }
};

const removeAvatar = () => {
  setImageId(null);
  setImageUrl(null);
};
```

Show ActivityIndicator overlay on avatar while uploading.
  </action>
  <verify>Run app, tap avatar, action sheet appears with all options</verify>
  <done>Avatar tap shows action sheet, camera/library work, image uploads to server</done>
</task>

<task type="auto">
  <name>Task 3: Implement save mutation and discard changes confirmation</name>
  <files>app/user-edit.tsx</files>
  <action>
**Save mutation** (from selah-web userEditProfileDialogMutation):
```graphql
mutation userUpdateMutation($input: UserUpdateInput!) {
  userUpdate(input: $input) {
    user {
      id
      name
      bio
      image {
        id
        url
      }
    }
  }
}
```

**Handle save**:
```typescript
const [commitUpdate, isSaving] = useMutation<userUpdateMutation>(mutation);

const handleSave = () => {
  commitUpdate({
    variables: {
      input: {
        name: name.trim(),
        bio: bio.trim() || undefined,
        imageId: imageId,
      },
    },
    onCompleted: () => {
      router.back();
    },
    onError: (error) => {
      Alert.alert('Error', 'Failed to save profile. Please try again.');
    },
  });
};
```

**Discard changes confirmation** (CONTEXT decision):
```typescript
import { useNavigation, usePreventRemove } from '@react-navigation/native';

// Prevent back navigation when there are unsaved changes
usePreventRemove(hasChanges && !isSaving, ({ data }) => {
  Alert.alert(
    'Discard Changes?',
    'You have unsaved changes. Are you sure you want to discard them?',
    [
      { text: 'Keep Editing', style: 'cancel' },
      {
        text: 'Discard',
        style: 'destructive',
        onPress: () => navigation.dispatch(data.action),
      },
    ]
  );
});

const handleCancel = () => {
  if (hasChanges) {
    Alert.alert(
      'Discard Changes?',
      'You have unsaved changes. Are you sure you want to discard them?',
      [
        { text: 'Keep Editing', style: 'cancel' },
        { text: 'Discard', style: 'destructive', onPress: () => router.back() },
      ]
    );
  } else {
    router.back();
  }
};
```

**Done button state**:
- Disabled when `!hasChanges || isSaving || isUploading`
- Shows ActivityIndicator when isSaving
- Text color changes when disabled (muted)
  </action>
  <verify>Edit name, tap Cancel, see confirmation dialog; tap Discard, changes lost</verify>
  <done>Save persists changes; Cancel with unsaved changes shows confirmation dialog</done>
</task>

</tasks>

<verification>
1. `npx relay-compiler` generates mutation types
2. `npx tsc --noEmit` passes
3. Navigate to edit profile, form shows current values
4. Change name, bio updates hasChanges state
5. Tap avatar, action sheet with 4 options appears
6. Pick image, upload indicator shows, image URL updates
7. Tap Done, changes save and navigate back
8. Edit something, tap Cancel, confirmation appears
9. Back gesture also triggers confirmation when changes exist
</verification>

<success_criteria>
- Edit profile screen accessible from profile tab
- Name and bio editable with character limits
- Avatar changeable via camera, library, or remove
- Done saves all changes atomically
- Cancel discards with confirmation when changes exist
- Back gesture protection works
</success_criteria>

<output>
After completion, create `.planning/phases/04-profiles-connections/04-03-SUMMARY.md`
</output>
