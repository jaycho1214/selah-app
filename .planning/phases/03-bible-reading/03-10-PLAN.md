---
phase: 03-bible-reading
plan: 10
type: fix
wave: 1
depends_on: []
files_modified:
  - lib/db/client.ts
  - lib/db/migrations/0000_init.sql
  - app/_layout.tsx
  - drizzle.config.ts
autonomous: true

must_haves:
  truths:
    - "SQLite tables are created on app startup"
    - "Database queries work without 'no such table' errors"
    - "Migrations run automatically before any database access"
  artifacts:
    - path: "lib/db/migrations/0000_init.sql"
      provides: "Initial migration creating all tables"
    - path: "lib/db/client.ts"
      provides: "Database client with migration runner"
  key_links:
    - from: "lib/db/client.ts"
      to: "drizzle-orm/expo-sqlite/migrator"
      via: "useMigrations hook"
      pattern: "useMigrations"
---

<objective>
Fix SQLite "no such table" error by adding Drizzle migrations.

Purpose: The app crashes because database tables were never created. Drizzle schema exists but migrations weren't run. This blocks all Bible reading functionality.

Output: Working database with auto-migrations on app startup.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-bible-reading/03-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate Drizzle migration files</name>
  <files>lib/db/migrations/0000_init.sql, drizzle.config.ts</files>
  <action>
Update `drizzle.config.ts` to ensure migrations output to correct directory:

```typescript
import type { Config } from 'drizzle-kit';

export default {
  schema: './lib/db/schema.ts',
  out: './lib/db/migrations',
  dialect: 'sqlite',
  driver: 'expo',
} satisfies Config;
```

Generate the initial migration:
```bash
npx drizzle-kit generate
```

This creates `lib/db/migrations/0000_*.sql` with CREATE TABLE statements for all tables defined in schema.ts.

Verify the generated SQL includes:
- translations table
- verses table
- highlights table
- bookmarks table
- notes table
  </action>
  <verify>
- Migration file exists at `lib/db/migrations/0000_*.sql`
- Contains CREATE TABLE for all 5 tables
  </verify>
  <done>Migration files generated with table definitions</done>
</task>

<task type="auto">
  <name>Task 2: Add migration runner to database client</name>
  <files>lib/db/client.ts</files>
  <action>
Update `lib/db/client.ts` to run migrations on initialization:

```typescript
import { drizzle } from 'drizzle-orm/expo-sqlite';
import { openDatabaseSync } from 'expo-sqlite';
import { useMigrations } from 'drizzle-orm/expo-sqlite/migrator';
import * as schema from './schema';
import migrations from './migrations/migrations';

/**
 * Opens the SQLite database synchronously.
 * enableChangeListener allows reactive queries in the future.
 */
const expoDb = openDatabaseSync('selah.db', { enableChangeListener: true });

/**
 * Drizzle ORM client for type-safe database queries.
 */
export const db = drizzle(expoDb, { schema });

/**
 * Hook to run migrations. Must be called in a React component
 * before any database operations.
 *
 * Usage in _layout.tsx:
 * ```typescript
 * const { success, error } = useDatabaseMigrations();
 * if (!success) return <LoadingScreen />;
 * ```
 */
export function useDatabaseMigrations() {
  return useMigrations(db, migrations);
}

export { expoDb };
```

Also create `lib/db/migrations/migrations.ts` to export the migrations:

```typescript
// This file is auto-generated by drizzle-kit
// Import all migration SQL files
import journal from './meta/_journal.json';
import m0000 from './0000_init.sql';

export default {
  journal,
  migrations: {
    m0000,
  },
};
```

NOTE: The exact file names will depend on what drizzle-kit generates. Adjust the imports accordingly.
  </action>
  <verify>
- `lib/db/client.ts` exports `useDatabaseMigrations` hook
- `lib/db/migrations/migrations.ts` exports migration bundle
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Database client includes migration runner hook</done>
</task>

<task type="auto">
  <name>Task 3: Run migrations on app startup</name>
  <files>app/_layout.tsx</files>
  <action>
Update `app/_layout.tsx` to run migrations before rendering the app:

```typescript
import { useDatabaseMigrations } from '@/lib/db/client';

// Inside the RootLayout component, add migration check:
export default function RootLayout() {
  // ... existing hooks (fonts, theme, etc.)

  // Run database migrations on startup
  const { success: dbReady, error: dbError } = useDatabaseMigrations();

  // Show loading while migrations run
  if (!dbReady) {
    // Return splash or loading screen
    // Note: If using expo-splash-screen, keep it visible
    return null; // or a loading component
  }

  // Log migration errors (but don't crash - tables might already exist)
  if (dbError) {
    console.warn('Database migration warning:', dbError);
  }

  // ... rest of layout
}
```

The migration check should happen early, before any components that might access the database.
  </action>
  <verify>
- App waits for migrations before rendering main content
- Database queries work without "no such table" errors
- App launches successfully on simulator
  </verify>
  <done>Migrations run automatically on app startup</done>
</task>

</tasks>

<verification>
1. Run `npx drizzle-kit generate` - creates migration files
2. TypeScript check: `npx tsc --noEmit` - no errors
3. Run app on simulator: `npx expo run:ios`
4. Navigate to Bible reader - no "no such table" errors
5. Check SQLite has tables: Use Expo dev tools or add debug logging
</verification>

<success_criteria>
- Drizzle migration files generated in lib/db/migrations/
- useDatabaseMigrations hook runs on app startup
- All 5 tables created (translations, verses, highlights, bookmarks, notes)
- No "no such table" SQLite errors
- App launches and Bible features work
</success_criteria>

<output>
After completion, create `.planning/phases/03-bible-reading/03-10-SUMMARY.md`
</output>
