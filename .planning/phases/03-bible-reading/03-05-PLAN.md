---
phase: 03-bible-reading
plan: 05
type: execute
wave: 4
depends_on: ["03-04"]
files_modified:
  - components/bible/verse-actions.tsx
  - components/bible/bible-reader.tsx
  - app/bible/[book]/[chapter].tsx
autonomous: true

must_haves:
  truths:
    - "Tapping verse shows color picker for highlights"
    - "User can select from 5 highlight colors"
    - "Highlight appears immediately on verse"
    - "Tapping highlighted verse allows removing highlight"
  artifacts:
    - path: "components/bible/verse-actions.tsx"
      provides: "Bottom sheet with verse actions including highlights"
      exports: ["VerseActions"]
  key_links:
    - from: "components/bible/verse-actions.tsx"
      to: "lib/stores/annotations-store.ts"
      via: "addHighlight, removeHighlight"
      pattern: "useAnnotationsStore"
    - from: "components/bible/verse-actions.tsx"
      to: "@gorhom/bottom-sheet"
      via: "BottomSheetModal"
      pattern: "BottomSheetModal"
    - from: "components/bible/bible-reader.tsx"
      to: "components/bible/chapter-view.tsx"
      via: "passes verseText through onVersePress/onVerseLongPress"
      pattern: "onVersePress.*verseText|onVerseLongPress.*verseText"
    - from: "app/bible/[book]/[chapter].tsx"
      to: "components/bible/verse-actions.tsx"
      via: "opens VerseActions with verseId and verseText"
      pattern: "verseActionsRef.*open.*verseId.*verseText"
---

<objective>
Implement verse highlighting with color selection via bottom sheet.

Purpose: Highlights help users mark meaningful verses. The bottom sheet provides a native-feeling action menu for verse interactions (BIBL-03).

Output: VerseActions bottom sheet with color picker, integrated with verse tap/long-press.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-bible-reading/03-RESEARCH.md
@.planning/phases/03-bible-reading/03-02-SUMMARY.md
@.planning/phases/03-bible-reading/03-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VerseActions bottom sheet</name>
  <files>components/bible/verse-actions.tsx</files>
  <action>
Create `components/bible/verse-actions.tsx`:

The app already has @gorhom/bottom-sheet installed (used in sign-in sheet). Create a verse actions sheet that shows when a verse is selected.

```typescript
import { useCallback, useMemo, forwardRef, useImperativeHandle, useRef } from 'react';
import { View, Text, Pressable } from 'react-native';
import BottomSheet, { BottomSheetBackdrop, BottomSheetView } from '@gorhom/bottom-sheet';
import { useAnnotationsStore, HIGHLIGHT_COLORS } from '@/lib/stores/annotations-store';

interface VerseActionsProps {
  onHighlight?: () => void;
  onBookmark?: () => void;
  onNote?: () => void;
  onShare?: () => void;
}

export interface VerseActionsRef {
  open: (verseId: string, verseText: string) => void;
  close: () => void;
}

export const VerseActions = forwardRef<VerseActionsRef, VerseActionsProps>(
  function VerseActions({ onHighlight, onBookmark, onNote, onShare }, ref) {
    const bottomSheetRef = useRef<BottomSheet>(null);
    const currentVerseRef = useRef<{ id: string; text: string } | null>(null);

    const { highlights, addHighlight, removeHighlight, bookmarks, addBookmark, removeBookmark } =
      useAnnotationsStore();

    const snapPoints = useMemo(() => ['35%'], []);

    useImperativeHandle(ref, () => ({
      open: (verseId: string, verseText: string) => {
        currentVerseRef.current = { id: verseId, text: verseText };
        bottomSheetRef.current?.expand();
      },
      close: () => {
        bottomSheetRef.current?.close();
        currentVerseRef.current = null;
      },
    }));

    const currentHighlight = currentVerseRef.current
      ? highlights[currentVerseRef.current.id]
      : null;

    const isBookmarked = currentVerseRef.current
      ? !!bookmarks[currentVerseRef.current.id]
      : false;

    const handleColorSelect = useCallback(
      (colorValue: string) => {
        if (!currentVerseRef.current) return;

        if (currentHighlight?.color === colorValue) {
          // Remove highlight if same color tapped
          removeHighlight(currentVerseRef.current.id);
        } else {
          addHighlight(currentVerseRef.current.id, colorValue);
        }
        onHighlight?.();
      },
      [currentHighlight, addHighlight, removeHighlight, onHighlight]
    );

    const handleRemoveHighlight = useCallback(() => {
      if (!currentVerseRef.current) return;
      removeHighlight(currentVerseRef.current.id);
      onHighlight?.();
    }, [removeHighlight, onHighlight]);

    const handleBookmarkToggle = useCallback(() => {
      if (!currentVerseRef.current) return;
      if (isBookmarked) {
        removeBookmark(currentVerseRef.current.id);
      } else {
        addBookmark(currentVerseRef.current.id);
      }
      onBookmark?.();
    }, [isBookmarked, addBookmark, removeBookmark, onBookmark]);

    const renderBackdrop = useCallback(
      (props: any) => (
        <BottomSheetBackdrop {...props} disappearsOnIndex={-1} appearsOnIndex={0} />
      ),
      []
    );

    return (
      <BottomSheet
        ref={bottomSheetRef}
        index={-1}
        snapPoints={snapPoints}
        enablePanDownToClose
        backdropComponent={renderBackdrop}
        backgroundStyle={{ backgroundColor: 'var(--background)' }}
        handleIndicatorStyle={{ backgroundColor: 'var(--muted-foreground)' }}
      >
        <BottomSheetView className="flex-1 px-4 pb-6">
          {/* Verse preview */}
          <Text
            className="text-muted-foreground text-sm mb-4 line-clamp-2"
            numberOfLines={2}
          >
            {currentVerseRef.current?.text}
          </Text>

          {/* Highlight colors */}
          <View className="mb-4">
            <Text className="text-foreground text-base font-semibold mb-3">
              Highlight
            </Text>
            <View className="flex-row gap-3">
              {HIGHLIGHT_COLORS.map((color) => (
                <Pressable
                  key={color.id}
                  onPress={() => handleColorSelect(color.value)}
                  className={`w-10 h-10 rounded-full items-center justify-center ${
                    currentHighlight?.color === color.value
                      ? 'border-2 border-foreground'
                      : ''
                  }`}
                  style={{ backgroundColor: color.value }}
                >
                  {currentHighlight?.color === color.value && (
                    <Text className="text-white text-lg">✓</Text>
                  )}
                </Pressable>
              ))}
              {/* Remove highlight button */}
              {currentHighlight && (
                <Pressable
                  onPress={handleRemoveHighlight}
                  className="w-10 h-10 rounded-full items-center justify-center border border-border bg-muted"
                >
                  <Text className="text-muted-foreground text-lg">✕</Text>
                </Pressable>
              )}
            </View>
          </View>

          {/* Action buttons */}
          <View className="flex-row gap-4">
            <Pressable
              onPress={handleBookmarkToggle}
              className="flex-1 py-3 rounded-lg bg-muted items-center"
            >
              <Text className="text-foreground">
                {isBookmarked ? 'Remove Bookmark' : 'Bookmark'}
              </Text>
            </Pressable>
            <Pressable
              onPress={onNote}
              className="flex-1 py-3 rounded-lg bg-muted items-center"
            >
              <Text className="text-foreground">Add Note</Text>
            </Pressable>
          </View>
        </BottomSheetView>
      </BottomSheet>
    );
  }
);
```

Note: The BottomSheet background color uses CSS variable which NativeWind should handle. If it doesn't work, replace with `className="bg-background"` on the sheet content or use theme context to get colors.
  </action>
  <verify>
- File exports `VerseActions` component and `VerseActionsRef` type
- Component shows 5 color options from HIGHLIGHT_COLORS
- Uses useAnnotationsStore for highlight state
- Checkmark shows on selected color
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>VerseActions bottom sheet with highlight colors created</done>
</task>

<task type="auto">
  <name>Task 2: Update BibleReader to pass verseText through callbacks</name>
  <files>components/bible/bible-reader.tsx</files>
  <action>
Update `components/bible/bible-reader.tsx` to include verseText in the callback signatures.

The BibleReader component passes onVersePress and onVerseLongPress to ChapterView. Update the interface and implementation to include the verseText parameter:

1. Update the interface:
```typescript
interface BibleReaderProps {
  initialBook: BibleBook;
  initialChapter: number;
  onPositionChange?: (book: BibleBook, chapter: number) => void;
  onVersePress?: (verseId: string, verseText?: string) => void;      // Add verseText
  onVerseLongPress?: (verseId: string, verseText?: string) => void;  // Add verseText
}
```

2. The ChapterView already passes verseText in its callbacks (updated in Plan 03-03), so BibleReader just needs to forward the parameters correctly:

```typescript
// In the BibleReader component JSX, verify ChapterView receives and passes through:
<ChapterView
  book={prev.book}
  chapter={prev.chapter}
  onVersePress={onVersePress}      // Already passes through - ChapterView now sends (verseId, verseText)
  onVerseLongPress={onVerseLongPress}  // Already passes through
/>
```

The key change is ensuring the TypeScript interface reflects the verseText parameter so that:
- BibleReaderProps accepts callbacks with verseText
- Parent components (like BibleChapterScreen) can receive verseText in their handlers
  </action>
  <verify>
- BibleReaderProps interface includes verseText in onVersePress and onVerseLongPress
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>BibleReader passes verseText through to parent callbacks</done>
</task>

<task type="auto">
  <name>Task 3: Integrate verse actions with Bible reader screen</name>
  <files>app/bible/[book]/[chapter].tsx</files>
  <action>
Update `app/bible/[book]/[chapter].tsx` to add VerseActions:

```typescript
import { useState, useCallback, useRef } from 'react';
import { View, Text, Pressable } from 'react-native';
import { useLocalSearchParams, router, Stack } from 'expo-router';
import { SafeAreaView } from 'react-native-safe-area-context';
import { BibleReader } from '@/components/bible/bible-reader';
import { BibleNavigator } from '@/components/bible/bible-navigator';
import { VerseActions, VerseActionsRef } from '@/components/bible/verse-actions';
import { BIBLE_BOOK_DETAILS } from '@/lib/bible/constants';
import { useBibleStore } from '@/lib/stores/bible-store';
import type { BibleBook } from '@/lib/bible/types';

export default function BibleChapterScreen() {
  const { book, chapter } = useLocalSearchParams<{ book: string; chapter: string }>();
  const { currentTranslation } = useBibleStore();
  const [navigatorVisible, setNavigatorVisible] = useState(false);
  const verseActionsRef = useRef<VerseActionsRef>(null);

  const currentBook = book as BibleBook;
  const currentChapter = parseInt(chapter, 10);
  const bookName = BIBLE_BOOK_DETAILS[currentBook]?.name ?? book;

  const handlePositionChange = useCallback(
    (newBook: BibleBook, newChapter: number) => {
      router.setParams({ book: newBook, chapter: String(newChapter) });
    },
    []
  );

  const handleNavigatorSelect = useCallback(
    (selectedBook: BibleBook, selectedChapter: number) => {
      router.setParams({ book: selectedBook, chapter: String(selectedChapter) });
    },
    []
  );

  // Open verse actions on tap or long-press
  // NOTE: verseText comes from ChapterView -> BibleReader -> here
  const handleVersePress = useCallback((verseId: string, verseText?: string) => {
    verseActionsRef.current?.open(verseId, verseText ?? '');
  }, []);

  const handleVerseLongPress = useCallback((verseId: string, verseText?: string) => {
    verseActionsRef.current?.open(verseId, verseText ?? '');
  }, []);

  const handleNotePress = useCallback(() => {
    // TODO: Open note editor (Plan 07)
    verseActionsRef.current?.close();
  }, []);

  return (
    <SafeAreaView className="flex-1 bg-background" edges={['top']}>
      <Stack.Screen
        options={{
          headerShown: true,
          headerTitle: () => (
            <Pressable onPress={() => setNavigatorVisible(true)}>
              <View className="items-center">
                <Text className="text-foreground text-lg font-semibold">
                  {bookName} {currentChapter}
                </Text>
                <Text className="text-muted-foreground text-xs">
                  {currentTranslation}
                </Text>
              </View>
            </Pressable>
          ),
        }}
      />

      <BibleReader
        initialBook={currentBook}
        initialChapter={currentChapter}
        onPositionChange={handlePositionChange}
        onVersePress={handleVersePress}
        onVerseLongPress={handleVerseLongPress}
      />

      <BibleNavigator
        currentBook={currentBook}
        currentChapter={currentChapter}
        onSelect={handleNavigatorSelect}
        visible={navigatorVisible}
        onClose={() => setNavigatorVisible(false)}
      />

      <VerseActions
        ref={verseActionsRef}
        onNote={handleNotePress}
      />
    </SafeAreaView>
  );
}
```

The key wiring is:
1. ChapterView (Plan 03-03) calls `onVersePress(verseId, item.text)` with verse text
2. BibleReader (Task 2) forwards the callback with verseText parameter
3. BibleChapterScreen (this task) receives `(verseId, verseText)` and passes to VerseActions
4. VerseActions.open(verseId, verseText) stores both for display and actions
  </action>
  <verify>
- Tapping a verse opens VerseActions bottom sheet
- Verse text preview shows in sheet (verseText is passed through the chain)
- Selecting a color adds highlight (visible immediately)
- Tapping same color removes highlight
- Bookmark button toggles bookmark state
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Highlights work end-to-end with color selection</done>
</task>

</tasks>

<verification>
1. TypeScript check: `npx tsc --noEmit` - no errors
2. App test: Open Bible reader, tap a verse
3. Verify verse text shows in bottom sheet preview
4. Color test: Select yellow highlight, verse background turns yellow
5. Toggle test: Tap yellow again, highlight is removed
6. Multiple verses: Highlight several verses with different colors
</verification>

<success_criteria>
- Tapping verse shows VerseActions bottom sheet (BIBL-03)
- Verse text preview displays in the bottom sheet
- 5 highlight colors available (yellow, green, blue, pink, orange)
- Selecting color immediately highlights verse
- Highlighted verses show background tint (15% opacity)
- Can remove highlight by tapping X or same color
- Bookmark toggle works (placeholder for Plan 06)
- verseText flows through: ChapterView -> BibleReader -> BibleChapterScreen -> VerseActions
</success_criteria>

<output>
After completion, create `.planning/phases/03-bible-reading/03-05-SUMMARY.md`
</output>
