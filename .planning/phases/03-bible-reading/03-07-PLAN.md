---
phase: 03-bible-reading
plan: 07
type: execute
wave: 4
depends_on: ["03-04", "03-05"]
files_modified:
  - components/bible/note-editor.tsx
  - app/notes.tsx
  - components/bible/verse-actions.tsx
autonomous: true

must_haves:
  truths:
    - "User can write and save a note on a verse"
    - "Note persists after closing editor"
    - "User can view list of all notes"
    - "User can edit existing note"
    - "User can delete a note"
  artifacts:
    - path: "components/bible/note-editor.tsx"
      provides: "Modal for creating/editing verse notes"
      exports: ["NoteEditor", "NoteEditorRef"]
    - path: "app/notes.tsx"
      provides: "Notes list screen"
  key_links:
    - from: "components/bible/note-editor.tsx"
      to: "lib/stores/annotations-store.ts"
      via: "setNote, removeNote"
      pattern: "useAnnotationsStore"
    - from: "components/bible/verse-actions.tsx"
      to: "components/bible/note-editor.tsx"
      via: "opens note editor on Note button"
      pattern: "noteEditorRef"
---

<objective>
Implement verse notes with editor modal and notes list screen.

Purpose: Private notes allow users to record thoughts and insights on verses (BIBL-05). Notes are stored locally and associated with specific verses.

Output: NoteEditor modal component, notes list screen, integration with verse actions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-bible-reading/03-02-SUMMARY.md
@.planning/phases/03-bible-reading/03-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NoteEditor modal</name>
  <files>components/bible/note-editor.tsx</files>
  <action>
Create `components/bible/note-editor.tsx`:

```typescript
import {
  forwardRef,
  useImperativeHandle,
  useRef,
  useState,
  useCallback,
} from 'react';
import {
  View,
  Text,
  TextInput,
  Pressable,
  Modal,
  KeyboardAvoidingView,
  Platform,
} from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useAnnotationsStore } from '@/lib/stores/annotations-store';
import { BIBLE_BOOK_DETAILS } from '@/lib/bible/constants';
import type { BibleBook } from '@/lib/bible/types';

export interface NoteEditorRef {
  open: (verseId: string, verseText: string) => void;
  close: () => void;
}

interface NoteEditorProps {
  onSave?: () => void;
  onDelete?: () => void;
}

// Parse verse ID into parts
function parseVerseId(verseId: string) {
  const parts = verseId.split(':');
  if (parts.length !== 4) return null;
  return {
    translation: parts[0],
    book: parts[1] as BibleBook,
    chapter: parseInt(parts[2], 10),
    verse: parseInt(parts[3], 10),
  };
}

export const NoteEditor = forwardRef<NoteEditorRef, NoteEditorProps>(
  function NoteEditor({ onSave, onDelete }, ref) {
    const [visible, setVisible] = useState(false);
    const [verseId, setVerseId] = useState<string | null>(null);
    const [verseText, setVerseText] = useState('');
    const [noteContent, setNoteContent] = useState('');
    const inputRef = useRef<TextInput>(null);

    const { notes, setNote, removeNote } = useAnnotationsStore();

    useImperativeHandle(ref, () => ({
      open: (id: string, text: string) => {
        setVerseId(id);
        setVerseText(text);
        const existingNote = notes[id];
        setNoteContent(existingNote?.content ?? '');
        setVisible(true);
        // Focus input after modal opens
        setTimeout(() => inputRef.current?.focus(), 100);
      },
      close: () => {
        setVisible(false);
        setVerseId(null);
        setVerseText('');
        setNoteContent('');
      },
    }));

    const parsed = verseId ? parseVerseId(verseId) : null;
    const reference = parsed
      ? `${BIBLE_BOOK_DETAILS[parsed.book]?.name ?? parsed.book} ${parsed.chapter}:${parsed.verse}`
      : '';

    const existingNote = verseId ? notes[verseId] : null;

    const handleSave = useCallback(() => {
      if (!verseId || !noteContent.trim()) return;
      setNote(verseId, noteContent.trim());
      setVisible(false);
      onSave?.();
    }, [verseId, noteContent, setNote, onSave]);

    const handleDelete = useCallback(() => {
      if (!verseId) return;
      removeNote(verseId);
      setVisible(false);
      onDelete?.();
    }, [verseId, removeNote, onDelete]);

    const handleClose = useCallback(() => {
      setVisible(false);
    }, []);

    return (
      <Modal
        visible={visible}
        animationType="slide"
        presentationStyle="pageSheet"
        onRequestClose={handleClose}
      >
        <SafeAreaView className="flex-1 bg-background">
          <KeyboardAvoidingView
            behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
            className="flex-1"
          >
            {/* Header */}
            <View className="flex-row items-center justify-between px-4 py-3 border-b border-border">
              <Pressable onPress={handleClose} className="p-2 -ml-2">
                <Text className="text-muted-foreground text-base">Cancel</Text>
              </Pressable>
              <Text className="text-foreground text-lg font-semibold">
                {existingNote ? 'Edit Note' : 'Add Note'}
              </Text>
              <Pressable
                onPress={handleSave}
                disabled={!noteContent.trim()}
                className="p-2 -mr-2"
              >
                <Text
                  className={`text-base font-medium ${
                    noteContent.trim() ? 'text-primary' : 'text-muted-foreground'
                  }`}
                >
                  Save
                </Text>
              </Pressable>
            </View>

            {/* Verse reference */}
            <View className="px-4 py-3 bg-muted/50 border-b border-border">
              <Text className="text-primary text-sm font-medium">{reference}</Text>
              <Text className="text-muted-foreground text-sm mt-1" numberOfLines={2}>
                {verseText}
              </Text>
            </View>

            {/* Note input */}
            <View className="flex-1 p-4">
              <TextInput
                ref={inputRef}
                value={noteContent}
                onChangeText={setNoteContent}
                placeholder="Write your note..."
                placeholderTextColor="#9CA3AF"
                multiline
                textAlignVertical="top"
                className="flex-1 text-foreground text-base"
                style={{ minHeight: 200 }}
              />
            </View>

            {/* Delete button (only for existing notes) */}
            {existingNote && (
              <View className="px-4 pb-4">
                <Pressable
                  onPress={handleDelete}
                  className="py-3 rounded-lg bg-destructive/10 items-center"
                >
                  <Text className="text-destructive font-medium">Delete Note</Text>
                </Pressable>
              </View>
            )}
          </KeyboardAvoidingView>
        </SafeAreaView>
      </Modal>
    );
  }
);
```

The editor opens as a modal with the verse reference, a text input for the note, and save/delete actions.
  </action>
  <verify>
- File exports `NoteEditor` and `NoteEditorRef`
- Modal shows verse reference and preview
- TextInput allows multiline note entry
- Save button disabled when empty
- Delete button appears for existing notes
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>NoteEditor modal for creating and editing verse notes</done>
</task>

<task type="auto">
  <name>Task 2: Create Notes list screen</name>
  <files>app/notes.tsx</files>
  <action>
Create `app/notes.tsx`:

```typescript
import { useCallback, useMemo, useRef } from 'react';
import { View, Text, Pressable } from 'react-native';
import { FlashList } from '@shopify/flash-list';
import { Stack, router } from 'expo-router';
import { SafeAreaView } from 'react-native-safe-area-context';
import { Trash2, FileText } from 'lucide-react-native';
import { NoteEditor, NoteEditorRef } from '@/components/bible/note-editor';
import { useAnnotationsStore } from '@/lib/stores/annotations-store';
import { BIBLE_BOOK_DETAILS } from '@/lib/bible/constants';
import type { BibleBook } from '@/lib/bible/types';

// Parse verse ID into parts
function parseVerseId(verseId: string) {
  const parts = verseId.split(':');
  if (parts.length !== 4) return null;
  return {
    translation: parts[0],
    book: parts[1] as BibleBook,
    chapter: parseInt(parts[2], 10),
    verse: parseInt(parts[3], 10),
  };
}

interface NoteItemProps {
  verseId: string;
  content: string;
  updatedAt: number;
  onPress: () => void;
  onDelete: () => void;
}

function NoteItem({ verseId, content, updatedAt, onPress, onDelete }: NoteItemProps) {
  const parsed = parseVerseId(verseId);
  const bookDetails = parsed ? BIBLE_BOOK_DETAILS[parsed.book] : null;
  const reference = parsed
    ? `${bookDetails?.name ?? parsed.book} ${parsed.chapter}:${parsed.verse}`
    : verseId;
  const dateStr = new Date(updatedAt).toLocaleDateString();

  return (
    <Pressable
      onPress={onPress}
      className="flex-row items-start px-4 py-3 border-b border-border active:bg-muted/50"
    >
      <FileText size={18} className="text-muted-foreground mt-1 mr-3" />
      <View className="flex-1">
        <Text className="text-primary text-sm font-medium">{reference}</Text>
        <Text className="text-foreground text-base mt-1" numberOfLines={3}>
          {content}
        </Text>
        <Text className="text-muted-foreground text-xs mt-1">{dateStr}</Text>
      </View>
      <Pressable
        onPress={(e) => {
          e.stopPropagation();
          onDelete();
        }}
        className="p-2 -mr-2"
        hitSlop={8}
      >
        <Trash2 size={18} className="text-muted-foreground" />
      </Pressable>
    </Pressable>
  );
}

export default function NotesScreen() {
  const { notes, removeNote } = useAnnotationsStore();
  const noteEditorRef = useRef<NoteEditorRef>(null);

  // Convert Record to sorted array (newest first)
  const notesList = useMemo(() => {
    return Object.values(notes).sort((a, b) => b.updatedAt - a.updatedAt);
  }, [notes]);

  const handleNotePress = useCallback(
    (verseId: string) => {
      // Open note editor to edit
      const note = notes[verseId];
      if (note) {
        noteEditorRef.current?.open(verseId, ''); // Verse text not available here
      }
    },
    [notes]
  );

  const handleDeleteNote = useCallback(
    (verseId: string) => {
      removeNote(verseId);
    },
    [removeNote]
  );

  const renderItem = useCallback(
    ({ item }: { item: (typeof notesList)[number] }) => (
      <NoteItem
        verseId={item.verseId}
        content={item.content}
        updatedAt={item.updatedAt}
        onPress={() => handleNotePress(item.verseId)}
        onDelete={() => handleDeleteNote(item.verseId)}
      />
    ),
    [handleNotePress, handleDeleteNote]
  );

  const keyExtractor = useCallback(
    (item: (typeof notesList)[number]) => item.verseId,
    []
  );

  return (
    <SafeAreaView className="flex-1 bg-background" edges={['top']}>
      <Stack.Screen
        options={{
          title: 'Notes',
          headerLargeTitle: true,
        }}
      />

      {notesList.length === 0 ? (
        <View className="flex-1 items-center justify-center p-8">
          <FileText size={48} className="text-muted-foreground mb-4" />
          <Text className="text-muted-foreground text-center text-lg">
            No notes yet
          </Text>
          <Text className="text-muted-foreground text-center text-sm mt-2">
            Add a note to a verse while reading
          </Text>
        </View>
      ) : (
        <FlashList
          data={notesList}
          renderItem={renderItem}
          keyExtractor={keyExtractor}
          estimatedItemSize={100}
        />
      )}

      <NoteEditor ref={noteEditorRef} />
    </SafeAreaView>
  );
}
```

Notes screen shows all notes sorted by most recently updated.
  </action>
  <verify>
- File exports default Notes screen
- Shows empty state when no notes
- Lists notes with verse reference and preview
- Tapping note opens editor for editing
- Delete button removes note
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Notes screen lists all verse notes</done>
</task>

<task type="auto">
  <name>Task 3: Integrate note editor with verse actions and home</name>
  <files>app/bible/[book]/[chapter].tsx, app/(tabs)/index.tsx</files>
  <action>
Update `app/bible/[book]/[chapter].tsx` to add note editor:

1. Import NoteEditor and ref
2. Add ref to component
3. Pass openNoteEditor callback to VerseActions
4. Wire the "Add Note" button

```typescript
// Add imports
import { NoteEditor, NoteEditorRef } from '@/components/bible/note-editor';

// In component, add ref
const noteEditorRef = useRef<NoteEditorRef>(null);

// Add handler
const handleOpenNoteEditor = useCallback((verseId: string, verseText: string) => {
  noteEditorRef.current?.open(verseId, verseText);
}, []);

// Update handleNotePress to open editor
const handleNotePress = useCallback(() => {
  // Get current verse from VerseActions
  verseActionsRef.current?.close();
  // The VerseActions should pass verse info to parent
}, []);

// Add NoteEditor to JSX
<NoteEditor ref={noteEditorRef} />
```

The VerseActions component needs to communicate the current verse to the parent. Update the onNote callback in VerseActions to include verse info:

In `components/bible/verse-actions.tsx`, modify to pass verse info:
```typescript
interface VerseActionsProps {
  onHighlight?: () => void;
  onBookmark?: () => void;
  onNote?: (verseId: string, verseText: string) => void; // Updated signature
  onShare?: () => void;
}

// In the Note button press:
<Pressable
  onPress={() => {
    if (currentVerseRef.current) {
      onNote?.(currentVerseRef.current.id, currentVerseRef.current.text);
    }
  }}
  ...
>
```

Update the Bible chapter screen handler:
```typescript
const handleNotePress = useCallback((verseId: string, verseText: string) => {
  verseActionsRef.current?.close();
  noteEditorRef.current?.open(verseId, verseText);
}, []);
```

Also add Notes entry point to home screen similar to bookmarks:
```typescript
// In app/(tabs)/index.tsx
import { FileText } from 'lucide-react-native';

// Add notes button after bookmarks
<Pressable
  onPress={() => router.push('/notes')}
  className="flex-row items-center justify-between bg-card rounded-xl p-4 shadow-sm border border-border mt-3"
>
  <View className="flex-row items-center gap-3">
    <FileText size={20} className="text-primary" />
    <Text className="text-foreground text-base">Notes</Text>
  </View>
  <Text className="text-muted-foreground">
    {Object.keys(notes).length}
  </Text>
</Pressable>

// Add notes to destructured store values
const { bookmarks, notes } = useAnnotationsStore();
```
  </action>
  <verify>
- Tapping "Add Note" in verse actions opens NoteEditor
- NoteEditor shows correct verse reference
- Saving note updates annotations store
- Notes accessible from home screen
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Notes feature fully integrated with verse actions</done>
</task>

</tasks>

<verification>
1. TypeScript check: `npx tsc --noEmit` - no errors
2. Add note: Open verse actions, tap "Add Note", write and save
3. View notes: Go to home, tap Notes, see saved note
4. Edit note: Tap note in list, modify content, save
5. Delete note: In note list, tap trash icon
</verification>

<success_criteria>
- User can add private notes to verses (BIBL-05)
- Notes persist in local storage
- Notes list shows all saved notes
- Can edit existing notes
- Can delete notes
- Note editor shows verse reference context
</success_criteria>

<output>
After completion, create `.planning/phases/03-bible-reading/03-07-SUMMARY.md`
</output>
