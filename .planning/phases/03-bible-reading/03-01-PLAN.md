---
phase: 03-bible-reading
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/db/client.ts
  - lib/db/schema.ts
  - lib/bible/types.ts
  - lib/bible/constants.ts
  - drizzle.config.ts
autonomous: true

must_haves:
  truths:
    - "SQLite database can be opened and queried"
    - "Bible book enum matches backend (66 books)"
    - "Schema supports verses, highlights, bookmarks, notes"
    - "Translations table includes version field for upgrade detection"
  artifacts:
    - path: "lib/db/client.ts"
      provides: "Drizzle client with expo-sqlite"
      exports: ["db"]
    - path: "lib/db/schema.ts"
      provides: "Database tables for offline storage"
      contains: "sqliteTable"
    - path: "lib/bible/types.ts"
      provides: "BibleBook enum, BibleVerse type"
      exports: ["BibleBook", "BibleVerse"]
    - path: "lib/bible/constants.ts"
      provides: "Book details with chapter counts"
      exports: ["BIBLE_BOOKS", "BIBLE_BOOK_DETAILS"]
  key_links:
    - from: "lib/db/client.ts"
      to: "expo-sqlite"
      via: "openDatabaseSync"
      pattern: "openDatabaseSync"
    - from: "lib/db/schema.ts"
      to: "drizzle-orm"
      via: "sqliteTable imports"
      pattern: "drizzle-orm/sqlite-core"
---

<objective>
Set up local SQLite database with Drizzle ORM and define Bible types/constants for the mobile app.

Purpose: All Bible reading features depend on local storage (offline reading, annotations) and consistent Bible data types. This foundation enables the entire phase.

Output: Database client, schema definitions, and ported Bible constants from selah-web.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-bible-reading/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install SQLite and Drizzle dependencies</name>
  <files>package.json</files>
  <action>
Install required packages for local database:
```bash
npx expo install expo-sqlite
npm install drizzle-orm
npm install -D drizzle-kit
```

Create `drizzle.config.ts` at project root:
```typescript
import type { Config } from 'drizzle-kit';

export default {
  schema: './lib/db/schema.ts',
  out: './lib/db/migrations',
  dialect: 'sqlite',
  driver: 'expo',
} satisfies Config;
```

Note: We use expo-sqlite (not react-native-sqlite-storage) because it's the Expo-supported module with sync/async API. Drizzle provides type-safe queries and migration support.
  </action>
  <verify>
- `npm ls expo-sqlite` shows package installed
- `npm ls drizzle-orm` shows package installed
- `drizzle.config.ts` exists at project root
  </verify>
  <done>SQLite and Drizzle packages installed, config file created</done>
</task>

<task type="auto">
  <name>Task 2: Create Drizzle client and database schema</name>
  <files>lib/db/client.ts, lib/db/schema.ts</files>
  <action>
Create `lib/db/client.ts`:
```typescript
import { drizzle } from 'drizzle-orm/expo-sqlite';
import { openDatabaseSync } from 'expo-sqlite';
import * as schema from './schema';

const expoDb = openDatabaseSync('selah.db', { enableChangeListener: true });
export const db = drizzle(expoDb, { schema });
```

Create `lib/db/schema.ts` with tables for:
1. `translations` - downloaded translation metadata (id, name, version, downloadedAt)
   - `version` field tracks the translation version (e.g., "2024.1") for upgrade detection
2. `verses` - Bible verse data (id format: "KJV:GENESIS:1:1", translationId, book, chapter, verse, text)
3. `highlights` - user highlights (id, verseId, color, createdAt, syncedAt)
4. `bookmarks` - user bookmarks (id, verseId, createdAt, syncedAt)
5. `notes` - user notes (id, verseId, content, createdAt, updatedAt, syncedAt)

Use `sqliteTable` from drizzle-orm/sqlite-core. Use `text` for IDs (UUIDs), `integer` for timestamps (mode: timestamp). The `syncedAt` field tracks server sync status (null = not synced). The `version` field enables checking for translation updates from the server.

Reference the schema patterns from 03-RESEARCH.md Pattern 2.
  </action>
  <verify>
- `lib/db/client.ts` exports `db`
- `lib/db/schema.ts` exports tables: translations, verses, highlights, bookmarks, notes
- TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>Drizzle client connects to SQLite, schema defines all required tables</done>
</task>

<task type="auto">
  <name>Task 3: Create Bible types and constants</name>
  <files>lib/bible/types.ts, lib/bible/constants.ts</files>
  <action>
Create `lib/bible/types.ts`:
```typescript
// BibleBook enum - must match backend exactly (66 books)
export enum BibleBook {
  GENESIS = "GENESIS",
  EXODUS = "EXODUS",
  // ... all 66 books in canonical order
  REVELATION = "REVELATION",
}

export type BibleTranslation = 'KJV' | 'ASV' | 'WEB';

export interface BibleVerse {
  id: string;
  book: BibleBook;
  chapter: number;
  verse: number;
  text: string;
  translationId: string;
}

export interface BibleBookDetail {
  name: string;
  shortName: string;
  chapters: number;
  testament: 'old' | 'new';
}
```

Create `lib/bible/constants.ts`:
```typescript
import { BibleBook, BibleBookDetail } from './types';

// Ordered array of all books (canonical order)
export const BIBLE_BOOKS: BibleBook[] = [
  BibleBook.GENESIS,
  BibleBook.EXODUS,
  // ... all 66 in order
];

// Details for each book
export const BIBLE_BOOK_DETAILS: Record<BibleBook, BibleBookDetail> = {
  [BibleBook.GENESIS]: { name: 'Genesis', shortName: 'Gen', chapters: 50, testament: 'old' },
  [BibleBook.EXODUS]: { name: 'Exodus', shortName: 'Exod', chapters: 40, testament: 'old' },
  // ... all 66 books with accurate chapter counts
};

export const TRANSLATIONS = [
  { id: 'KJV', name: 'King James Version' },
  { id: 'ASV', name: 'American Standard Version' },
  { id: 'WEB', name: 'World English Bible' },
] as const;
```

Port the BibleBook enum from selah-web/src/server/db-types.ts (66 books). Ensure book order follows canonical Bible order (Genesis to Revelation), not alphabetical.

Include accurate chapter counts for each book (Genesis: 50, Exodus: 40, ... Revelation: 22).
  </action>
  <verify>
- `lib/bible/types.ts` exports BibleBook with 66 values
- `lib/bible/constants.ts` exports BIBLE_BOOKS array with 66 entries
- BIBLE_BOOK_DETAILS has chapter counts for all books
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Bible types match backend, constants provide book metadata for navigation</done>
</task>

</tasks>

<verification>
1. Run TypeScript check: `npx tsc --noEmit` - no errors
2. Verify database opens: Create a simple test in a component that imports db and runs a query
3. Verify BibleBook enum has exactly 66 entries matching backend
</verification>

<success_criteria>
- expo-sqlite and drizzle-orm installed and configured
- Database schema supports verses, highlights, bookmarks, notes tables
- BibleBook enum matches backend exactly (same 66 book names)
- BIBLE_BOOK_DETAILS has accurate chapter counts for all 66 books
- All TypeScript types compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-bible-reading/03-01-SUMMARY.md`
</output>
