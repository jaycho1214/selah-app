---
phase: 03-bible-reading
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/stores/bible-store.ts
  - lib/stores/settings-store.ts
  - lib/stores/annotations-store.ts
  - lib/storage.ts
autonomous: true

must_haves:
  truths:
    - "Settings persist across app restarts"
    - "Reading position (book, chapter) is remembered"
    - "Font size preference is stored and retrievable"
  artifacts:
    - path: "lib/storage.ts"
      provides: "MMKV storage instance"
      exports: ["storage", "mmkvStorage"]
    - path: "lib/stores/bible-store.ts"
      provides: "Current reading position and translation"
      exports: ["useBibleStore"]
    - path: "lib/stores/settings-store.ts"
      provides: "Font size and display preferences"
      exports: ["useSettingsStore"]
    - path: "lib/stores/annotations-store.ts"
      provides: "Local annotation state before SQLite"
      exports: ["useAnnotationsStore"]
  key_links:
    - from: "lib/stores/bible-store.ts"
      to: "lib/storage.ts"
      via: "Zustand persist middleware"
      pattern: "persist.*storage"
    - from: "lib/storage.ts"
      to: "react-native-mmkv"
      via: "MMKV constructor"
      pattern: "new MMKV"
---

<objective>
Set up Zustand stores with MMKV persistence for Bible reading state, settings, and annotations.

Purpose: User preferences (font size, last position, translation) must persist instantly and survive app restarts. MMKV is 30-100x faster than AsyncStorage for synchronous reads.

Output: Persistent stores for reading position, display settings, and annotation state.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-bible-reading/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install MMKV and Zustand</name>
  <files>package.json</files>
  <action>
Install required packages:
```bash
npx expo install react-native-mmkv
npm install zustand
```

Note: react-native-mmkv requires native modules. After installation, if testing on device/simulator, a rebuild may be needed (`npx expo run:ios` or `npx expo run:android`).

Zustand v5.x is the current stable version with persist middleware built-in.
  </action>
  <verify>
- `npm ls react-native-mmkv` shows package installed
- `npm ls zustand` shows package installed (v5.x)
  </verify>
  <done>MMKV and Zustand packages installed</done>
</task>

<task type="auto">
  <name>Task 2: Create MMKV storage adapter</name>
  <files>lib/storage.ts</files>
  <action>
Create `lib/storage.ts`:
```typescript
import { MMKV } from 'react-native-mmkv';
import { StateStorage } from 'zustand/middleware';

// Single MMKV instance for all settings
export const storage = new MMKV({ id: 'selah-storage' });

// Zustand-compatible storage adapter
export const mmkvStorage: StateStorage = {
  getItem: (name: string) => {
    const value = storage.getString(name);
    return value ?? null;
  },
  setItem: (name: string, value: string) => {
    storage.set(name, value);
  },
  removeItem: (name: string) => {
    storage.delete(name);
  },
};
```

This adapter allows Zustand persist middleware to use MMKV for synchronous storage. The `selah-storage` ID keeps our data separate from any other MMKV instances.
  </action>
  <verify>
- `lib/storage.ts` exports `storage` (MMKV instance)
- `lib/storage.ts` exports `mmkvStorage` (StateStorage adapter)
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>MMKV storage adapter ready for Zustand</done>
</task>

<task type="auto">
  <name>Task 3: Create Zustand stores with persistence</name>
  <files>lib/stores/bible-store.ts, lib/stores/settings-store.ts, lib/stores/annotations-store.ts</files>
  <action>
Create `lib/stores/bible-store.ts`:
```typescript
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import { mmkvStorage } from '../storage';

interface BibleStore {
  // Current reading position
  currentBook: string;
  currentChapter: number;
  currentTranslation: string;

  // Actions
  setPosition: (book: string, chapter: number) => void;
  setTranslation: (translation: string) => void;
}

export const useBibleStore = create<BibleStore>()(
  persist(
    (set) => ({
      currentBook: 'GENESIS',
      currentChapter: 1,
      currentTranslation: 'KJV',

      setPosition: (currentBook, currentChapter) =>
        set({ currentBook, currentChapter }),
      setTranslation: (currentTranslation) =>
        set({ currentTranslation }),
    }),
    {
      name: 'bible-store',
      storage: createJSONStorage(() => mmkvStorage),
    }
  )
);
```

Create `lib/stores/settings-store.ts`:
```typescript
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import { mmkvStorage } from '../storage';

export type FontSize = 'small' | 'medium' | 'large';

interface SettingsStore {
  fontSize: FontSize;
  setFontSize: (size: FontSize) => void;
}

export const useSettingsStore = create<SettingsStore>()(
  persist(
    (set) => ({
      fontSize: 'medium',
      setFontSize: (fontSize) => set({ fontSize }),
    }),
    {
      name: 'settings-store',
      storage: createJSONStorage(() => mmkvStorage),
    }
  )
);

// Font size values in pixels
export const FONT_SIZES = {
  small: { text: 15, verse: 12, lineHeight: 22 },
  medium: { text: 17, verse: 14, lineHeight: 26 },
  large: { text: 20, verse: 16, lineHeight: 30 },
} as const;
```

Create `lib/stores/annotations-store.ts`:
```typescript
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import { mmkvStorage } from '../storage';

// Highlight colors available to user
export const HIGHLIGHT_COLORS = [
  { id: 'yellow', name: 'Yellow', value: '#FACC15' },
  { id: 'green', name: 'Green', value: '#4ADE80' },
  { id: 'blue', name: 'Blue', value: '#60A5FA' },
  { id: 'pink', name: 'Pink', value: '#F472B6' },
  { id: 'orange', name: 'Orange', value: '#FB923C' },
] as const;

interface Highlight {
  verseId: string;
  color: string;
  createdAt: number;
}

interface Bookmark {
  verseId: string;
  createdAt: number;
}

interface Note {
  verseId: string;
  content: string;
  createdAt: number;
  updatedAt: number;
}

interface AnnotationsStore {
  highlights: Record<string, Highlight>;
  bookmarks: Record<string, Bookmark>;
  notes: Record<string, Note>;

  // Highlight actions
  addHighlight: (verseId: string, color: string) => void;
  removeHighlight: (verseId: string) => void;

  // Bookmark actions
  addBookmark: (verseId: string) => void;
  removeBookmark: (verseId: string) => void;

  // Note actions
  setNote: (verseId: string, content: string) => void;
  removeNote: (verseId: string) => void;
}

export const useAnnotationsStore = create<AnnotationsStore>()(
  persist(
    (set) => ({
      highlights: {},
      bookmarks: {},
      notes: {},

      addHighlight: (verseId, color) => set((state) => ({
        highlights: {
          ...state.highlights,
          [verseId]: { verseId, color, createdAt: Date.now() },
        },
      })),
      removeHighlight: (verseId) => set((state) => {
        const { [verseId]: _, ...rest } = state.highlights;
        return { highlights: rest };
      }),

      addBookmark: (verseId) => set((state) => ({
        bookmarks: {
          ...state.bookmarks,
          [verseId]: { verseId, createdAt: Date.now() },
        },
      })),
      removeBookmark: (verseId) => set((state) => {
        const { [verseId]: _, ...rest } = state.bookmarks;
        return { bookmarks: rest };
      }),

      setNote: (verseId, content) => set((state) => {
        const existing = state.notes[verseId];
        return {
          notes: {
            ...state.notes,
            [verseId]: {
              verseId,
              content,
              createdAt: existing?.createdAt ?? Date.now(),
              updatedAt: Date.now(),
            },
          },
        };
      }),
      removeNote: (verseId) => set((state) => {
        const { [verseId]: _, ...rest } = state.notes;
        return { notes: rest };
      }),
    }),
    {
      name: 'annotations-store',
      storage: createJSONStorage(() => mmkvStorage),
    }
  )
);
```

The annotations store uses Record<verseId, Annotation> for O(1) lookups when rendering verses. This is faster than arrays for checking if a verse has a highlight/bookmark.
  </action>
  <verify>
- All three stores export their hooks: `useBibleStore`, `useSettingsStore`, `useAnnotationsStore`
- TypeScript compiles: `npx tsc --noEmit`
- Stores use persist middleware with mmkvStorage
  </verify>
  <done>Zustand stores persist reading position, settings, and annotations to MMKV</done>
</task>

</tasks>

<verification>
1. TypeScript check: `npx tsc --noEmit` - no errors
2. Import test: Create a test component that uses all three stores
3. Verify store actions update state correctly (can test in app or via console)
</verification>

<success_criteria>
- MMKV and Zustand installed
- Storage adapter connects Zustand to MMKV
- useBibleStore tracks current book, chapter, translation
- useSettingsStore tracks font size preference
- useAnnotationsStore tracks highlights, bookmarks, notes by verseId
- All stores persist to MMKV (data survives app restart)
</success_criteria>

<output>
After completion, create `.planning/phases/03-bible-reading/03-02-SUMMARY.md`
</output>
