---
phase: 03-bible-reading
plan: 08
type: execute
wave: 4
depends_on: ["03-04"]
files_modified:
  - app/search.tsx
  - components/bible/search-bar.tsx
  - lib/relay/__generated__/SearchBibleQuery.graphql.ts
autonomous: true

must_haves:
  truths:
    - "User can enter search query"
    - "Search results show matching verses"
    - "Results show verse reference and text preview"
    - "Tapping result navigates to that chapter"
  artifacts:
    - path: "app/search.tsx"
      provides: "Bible search screen"
    - path: "components/bible/search-bar.tsx"
      provides: "Search input component"
      exports: ["SearchBar"]
  key_links:
    - from: "app/search.tsx"
      to: "graphql"
      via: "bibleVersesByQuery query"
      pattern: "bibleVersesByQuery"
    - from: "app/search.tsx"
      to: "expo-router"
      via: "router.push to verse"
      pattern: "router.push.*bible"
---

<objective>
Create Bible search functionality using the GraphQL API.

Purpose: Users need to find verses by keyword (BIBL-06). The backend provides full-text search via `bibleVersesByQuery`.

Output: Search screen with text input, results list, and navigation to matching verses.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-bible-reading/03-RESEARCH.md
@.planning/phases/03-bible-reading/03-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SearchBar component</name>
  <files>components/bible/search-bar.tsx</files>
  <action>
Create `components/bible/search-bar.tsx`:

```typescript
import { useState, useCallback } from 'react';
import { View, TextInput, Pressable } from 'react-native';
import { Search, X } from 'lucide-react-native';

interface SearchBarProps {
  value: string;
  onChangeText: (text: string) => void;
  onSubmit: () => void;
  onClear: () => void;
  placeholder?: string;
  autoFocus?: boolean;
}

export function SearchBar({
  value,
  onChangeText,
  onSubmit,
  onClear,
  placeholder = 'Search the Bible...',
  autoFocus = false,
}: SearchBarProps) {
  return (
    <View className="flex-row items-center bg-muted rounded-lg px-3 py-2">
      <Search size={18} className="text-muted-foreground mr-2" />
      <TextInput
        value={value}
        onChangeText={onChangeText}
        onSubmitEditing={onSubmit}
        placeholder={placeholder}
        placeholderTextColor="#9CA3AF"
        returnKeyType="search"
        autoFocus={autoFocus}
        autoCapitalize="none"
        autoCorrect={false}
        className="flex-1 text-foreground text-base py-1"
      />
      {value.length > 0 && (
        <Pressable onPress={onClear} className="p-1">
          <X size={18} className="text-muted-foreground" />
        </Pressable>
      )}
    </View>
  );
}
```

Simple search input with icon, clear button, and submit handling.
  </action>
  <verify>
- File exports `SearchBar` component
- Input handles text changes
- Clear button appears when text present
- Submit triggers onSubmit callback
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>SearchBar component with input and clear button</done>
</task>

<task type="auto">
  <name>Task 2: Create Search screen with GraphQL query</name>
  <files>app/search.tsx</files>
  <action>
Create `app/search.tsx`:

```typescript
import { useState, useCallback, Suspense } from 'react';
import { View, Text, Pressable, ActivityIndicator } from 'react-native';
import { FlashList } from '@shopify/flash-list';
import { Stack, router } from 'expo-router';
import { SafeAreaView } from 'react-native-safe-area-context';
import { graphql, useLazyLoadQuery } from 'react-relay';
import { SearchBar } from '@/components/bible/search-bar';
import { useBibleStore } from '@/lib/stores/bible-store';
import { BIBLE_BOOK_DETAILS } from '@/lib/bible/constants';
import type { BibleBook } from '@/lib/bible/types';
import type { SearchBibleQuery } from '@/lib/relay/__generated__/SearchBibleQuery.graphql';

const searchQuery = graphql`
  query SearchBibleQuery($translation: String!, $query: String!, $limit: Int) {
    bibleVersesByQuery(translationId: $translation, query: $query, limit: $limit) {
      id
      book
      chapter
      verse
      text
    }
  }
`;

interface SearchResultItemProps {
  verse: {
    id: string;
    book: BibleBook;
    chapter: number;
    verse: number;
    text: string;
  };
  query: string;
  onPress: () => void;
}

function SearchResultItem({ verse, query, onPress }: SearchResultItemProps) {
  const bookDetails = BIBLE_BOOK_DETAILS[verse.book];
  const reference = `${bookDetails?.name ?? verse.book} ${verse.chapter}:${verse.verse}`;

  // Highlight matching text (simple approach)
  const highlightText = (text: string, query: string) => {
    if (!query.trim()) return text;
    const words = query.toLowerCase().split(/\s+/);
    let result = text;
    // Just return text for now - highlighting can be complex
    return result;
  };

  return (
    <Pressable
      onPress={onPress}
      className="px-4 py-3 border-b border-border active:bg-muted/50"
    >
      <Text className="text-primary text-sm font-medium">{reference}</Text>
      <Text className="text-foreground text-base mt-1" numberOfLines={3}>
        {verse.text}
      </Text>
    </Pressable>
  );
}

function SearchResults({
  query,
  translation,
}: {
  query: string;
  translation: string;
}) {
  const data = useLazyLoadQuery<SearchBibleQuery>(
    searchQuery,
    {
      translation,
      query,
      limit: 50,
    },
    { fetchPolicy: 'store-or-network' }
  );

  const results = data.bibleVersesByQuery ?? [];

  const handleResultPress = useCallback((verse: { book: BibleBook; chapter: number }) => {
    router.push(`/bible/${verse.book}/${verse.chapter}`);
  }, []);

  const renderItem = useCallback(
    ({ item }: { item: (typeof results)[number] }) => (
      <SearchResultItem
        verse={item as SearchResultItemProps['verse']}
        query={query}
        onPress={() => handleResultPress(item as { book: BibleBook; chapter: number })}
      />
    ),
    [query, handleResultPress]
  );

  const keyExtractor = useCallback(
    (item: (typeof results)[number]) => item.id,
    []
  );

  if (results.length === 0) {
    return (
      <View className="flex-1 items-center justify-center p-8">
        <Text className="text-muted-foreground text-center text-lg">
          No results found
        </Text>
        <Text className="text-muted-foreground text-center text-sm mt-2">
          Try different keywords
        </Text>
      </View>
    );
  }

  return (
    <FlashList
      data={results}
      renderItem={renderItem}
      keyExtractor={keyExtractor}
      estimatedItemSize={100}
      ListHeaderComponent={
        <View className="px-4 py-2 bg-muted">
          <Text className="text-muted-foreground text-sm">
            {results.length} result{results.length !== 1 ? 's' : ''}
          </Text>
        </View>
      }
    />
  );
}

export default function SearchScreen() {
  const { currentTranslation } = useBibleStore();
  const [searchText, setSearchText] = useState('');
  const [submittedQuery, setSubmittedQuery] = useState('');

  const handleSubmit = useCallback(() => {
    if (searchText.trim().length >= 3) {
      setSubmittedQuery(searchText.trim());
    }
  }, [searchText]);

  const handleClear = useCallback(() => {
    setSearchText('');
    setSubmittedQuery('');
  }, []);

  return (
    <SafeAreaView className="flex-1 bg-background" edges={['top']}>
      <Stack.Screen
        options={{
          title: 'Search',
          headerLargeTitle: true,
        }}
      />

      {/* Search input */}
      <View className="px-4 py-2">
        <SearchBar
          value={searchText}
          onChangeText={setSearchText}
          onSubmit={handleSubmit}
          onClear={handleClear}
          autoFocus
        />
        <Text className="text-muted-foreground text-xs mt-2">
          Searching in {currentTranslation} â€¢ Minimum 3 characters
        </Text>
      </View>

      {/* Results */}
      {submittedQuery ? (
        <Suspense
          fallback={
            <View className="flex-1 items-center justify-center">
              <ActivityIndicator size="large" />
            </View>
          }
        >
          <SearchResults query={submittedQuery} translation={currentTranslation} />
        </Suspense>
      ) : (
        <View className="flex-1 items-center justify-center p-8">
          <Text className="text-muted-foreground text-center">
            Enter a word or phrase to search
          </Text>
        </View>
      )}
    </SafeAreaView>
  );
}
```

After creating, run Relay compiler:
```bash
npm run relay
```
  </action>
  <verify>
- File exports default Search screen
- GraphQL query defined for `bibleVersesByQuery`
- `npm run relay` generates SearchBibleQuery.graphql.ts
- Results display verse reference and text
- Tapping result navigates to chapter
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Search screen with GraphQL query and results</done>
</task>

<task type="auto">
  <name>Task 3: Add search entry point to navigation</name>
  <files>app/(tabs)/index.tsx</files>
  <action>
Add search entry point to home screen:

```typescript
// Add import
import { Search } from 'lucide-react-native';

// Add search button to home screen
<Pressable
  onPress={() => router.push('/search')}
  className="flex-row items-center justify-between bg-card rounded-xl p-4 shadow-sm border border-border mt-3"
>
  <View className="flex-row items-center gap-3">
    <Search size={20} className="text-primary" />
    <Text className="text-foreground text-base">Search Bible</Text>
  </View>
</Pressable>
```

Also consider adding a search icon to the Bible reader header. In `app/bible/[book]/[chapter].tsx`:

```typescript
import { Search } from 'lucide-react-native';

// In Stack.Screen options, add headerRight:
headerRight: () => (
  <Pressable onPress={() => router.push('/search')} className="p-2">
    <Search size={22} className="text-foreground" />
  </Pressable>
),
```
  </action>
  <verify>
- Search accessible from home screen
- Search icon in Bible reader header
- Route `/search` works
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Search accessible from multiple entry points</done>
</task>

</tasks>

<verification>
1. TypeScript check: `npx tsc --noEmit` - no errors
2. Relay compile: `npm run relay` - generates query types
3. Search test: Navigate to search, enter "love", see results
4. Navigation test: Tap a result, opens Bible at that chapter
5. Empty/short query: Shows appropriate messages
</verification>

<success_criteria>
- User can search Bible by keyword (BIBL-06)
- Results show verse reference and text preview
- Minimum 3 characters required for search
- Results use current translation setting
- Tapping result navigates to chapter
- Search accessible from home and Bible reader
</success_criteria>

<output>
After completion, create `.planning/phases/03-bible-reading/03-08-SUMMARY.md`
</output>
