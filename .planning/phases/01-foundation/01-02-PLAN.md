---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/relay/network.ts
  - lib/relay/environment.ts
  - components/providers/relay-provider.tsx
  - app/_layout.tsx
  - relay.config.js
  - schema.graphql
  - babel.config.js
  - package.json
autonomous: true
user_setup:
  - service: selah-api
    why: "GraphQL API endpoint"
    env_vars:
      - name: EXPO_PUBLIC_API_URL
        source: "Use https://api.joinselah.com/graphql for production or local dev server"

must_haves:
  truths:
    - "Relay environment is configured and exported"
    - "Test query successfully fetches data from GraphQL API"
    - "Relay compiler runs without errors"
    - "App wraps content in RelayEnvironmentProvider"
  artifacts:
    - path: "lib/relay/environment.ts"
      provides: "Relay environment singleton"
      exports: ["environment"]
    - path: "lib/relay/network.ts"
      provides: "Network layer with fetch function"
      exports: ["fetchGraphQL"]
    - path: "components/providers/relay-provider.tsx"
      provides: "Relay context provider component"
      exports: ["RelayProvider"]
    - path: "relay.config.js"
      provides: "Relay compiler configuration"
      contains: "schema"
    - path: "schema.graphql"
      provides: "GraphQL schema for type generation"
      contains: "type Query"
  key_links:
    - from: "app/_layout.tsx"
      to: "components/providers/relay-provider.tsx"
      via: "RelayProvider wrapper"
      pattern: "<RelayProvider>"
    - from: "lib/relay/environment.ts"
      to: "lib/relay/network.ts"
      via: "Network.create import"
      pattern: "Network\\.create\\(fetchGraphQL\\)"
---

<objective>
Set up Relay environment with GraphQL connection to the selah-api backend.

Purpose: Establish the data layer that will power all GraphQL queries throughout the app.
Output: Working Relay environment with test query verifying API connection.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@package.json
@app/_layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Relay dependencies and configure compiler</name>
  <files>
    package.json
    relay.config.js
    babel.config.js
    schema.graphql
    lib/relay/__generated__/.gitkeep
  </files>
  <action>
    1. Install Relay packages:
       ```bash
       npm install react-relay graphql relay-runtime
       npm install -D relay-compiler babel-plugin-relay @types/react-relay @types/relay-runtime
       ```

    2. Create `relay.config.js` in project root:
       ```javascript
       module.exports = {
         src: './app',
         schema: './schema.graphql',
         language: 'typescript',
         artifactDirectory: './lib/relay/__generated__',
         exclude: ['**/node_modules/**', '**/__mocks__/**', '**/__generated__/**'],
       };
       ```

    3. Update `babel.config.js` to add relay plugin:
       - Keep existing presets
       - Add `plugins: ['relay']` to the config
       - Note: Do NOT add 'nativewind/babel' yet (that's Plan 03)

    4. Copy GraphQL schema from selah-web or fetch from API:
       - Location: `/Users/jay/Codes/selah/selah-web/schema.graphql`
       - Copy to project root as `schema.graphql`
       - If not available, create minimal placeholder schema with Query type

    5. Create directory `lib/relay/__generated__/` with `.gitkeep` file

    6. Add npm scripts to package.json:
       ```json
       "scripts": {
         "relay": "relay-compiler",
         "relay:watch": "relay-compiler --watch"
       }
       ```

    7. Run `npm run relay` to verify compiler works (may have no output if no queries yet)
  </action>
  <verify>
    - `npm run relay` runs without errors
    - `relay.config.js` exists
    - `schema.graphql` exists with at least Query type
    - `lib/relay/__generated__/` directory exists
  </verify>
  <done>
    Relay compiler configured and runs successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Relay environment and network layer</name>
  <files>
    lib/relay/network.ts
    lib/relay/environment.ts
    components/providers/relay-provider.tsx
    app/_layout.tsx
  </files>
  <action>
    1. Create `lib/relay/network.ts`:
       ```typescript
       import { RequestParameters, Variables, GraphQLResponse } from 'relay-runtime';

       const API_URL = process.env.EXPO_PUBLIC_API_URL || 'https://api.joinselah.com/graphql';

       export async function fetchGraphQL(
         request: RequestParameters,
         variables: Variables,
       ): Promise<GraphQLResponse> {
         // Auth token will be added in Phase 2 (authentication)
         const response = await fetch(API_URL, {
           method: 'POST',
           headers: {
             'Content-Type': 'application/json',
           },
           body: JSON.stringify({
             query: request.text,
             variables,
           }),
         });

         return response.json();
       }
       ```

    2. Create `lib/relay/environment.ts`:
       ```typescript
       import {
         Environment,
         Network,
         RecordSource,
         Store,
       } from 'relay-runtime';
       import { fetchGraphQL } from './network';

       const network = Network.create(fetchGraphQL);
       const store = new Store(new RecordSource());

       export const environment = new Environment({
         network,
         store,
       });
       ```

    3. Create `components/providers/relay-provider.tsx`:
       ```typescript
       import { ReactNode } from 'react';
       import { RelayEnvironmentProvider } from 'react-relay';
       import { environment } from '@/lib/relay/environment';

       interface RelayProviderProps {
         children: ReactNode;
       }

       export function RelayProvider({ children }: RelayProviderProps) {
         return (
           <RelayEnvironmentProvider environment={environment}>
             {children}
           </RelayEnvironmentProvider>
         );
       }
       ```

    4. Update `app/_layout.tsx`:
       - Import RelayProvider from '@/components/providers/relay-provider'
       - Wrap existing ThemeProvider content with RelayProvider
       - RelayProvider should be the outermost provider (before ThemeProvider)
       - Keep all existing functionality (Stack, StatusBar, etc.)

    Note: We're not adding auth headers yet - that's Phase 2. This is just the foundation.
  </action>
  <verify>
    - App starts without errors: `npx expo start`
    - No console errors about Relay or GraphQL
    - Check that RelayProvider wraps the app in _layout.tsx
  </verify>
  <done>
    Relay environment created, network layer configured, and app wrapped in RelayEnvironmentProvider.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add test query to verify GraphQL connection</name>
  <files>
    app/(tabs)/explore.tsx
  </files>
  <action>
    1. Create a simple test query in explore.tsx to verify the connection works:
       ```typescript
       import { graphql, useLazyLoadQuery } from 'react-relay';

       // Define a simple query - adjust based on actual schema
       // If schema has a 'viewer' or 'me' query, use that
       // Otherwise use __typename on Query for basic connectivity test
       const TestQuery = graphql`
         query exploreTestQuery {
           __typename
         }
       `;
       ```

    2. Create a test component that uses the query:
       - Wrap the query usage in Suspense
       - Show loading state while query executes
       - Show result or error state
       - This is temporary - just to prove connection works

    3. Update explore screen to show query result:
       - If query succeeds: show "Connected to GraphQL API"
       - If query fails: show error message
       - This proves Relay is correctly configured

    4. Run relay compiler: `npm run relay`
       - This should generate types in lib/relay/__generated__/

    IMPORTANT: The actual query depends on what's in schema.graphql.
    - If schema has `viewer: User` query, use that
    - If schema has no queries yet, use `__typename` as introspection
    - The goal is proving the connection works, not fetching real data

    If the API requires authentication for all queries:
    - Use a public query if available
    - Or skip the actual query test and just verify environment compiles
    - Note that full testing requires Phase 2 (auth)
  </action>
  <verify>
    - `npm run relay` generates files in lib/relay/__generated__/
    - App compiles without Relay errors
    - Explore tab either:
      a) Shows "Connected to GraphQL API" (if public query works), or
      b) Shows appropriate error handling (if auth required), or
      c) Compiles successfully with Suspense boundary (proving setup is correct)
  </verify>
  <done>
    Test query added and Relay compiler generates types; connection verified or error handled gracefully.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. `npm run relay` - Compiler runs without errors
2. `npx expo start` - App launches without Relay-related errors
3. Check generated files exist: `ls lib/relay/__generated__/`
4. Explore tab shows query result (success or handled error)
5. No TypeScript errors in relay-related files
</verification>

<success_criteria>
- Relay compiler runs without errors (`npm run relay`)
- Relay environment is created and exported
- App wraps content in RelayEnvironmentProvider
- Test query demonstrates GraphQL connection (success or handled error)
- Generated types exist in lib/relay/__generated__/
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
