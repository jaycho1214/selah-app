---
phase: 05-feed-engagement
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - app/(tabs)/posts.tsx
  - lib/stores/feed-store.ts
autonomous: true

must_haves:
  truths:
    - "User sees two sub-tabs (For You and Following) on the Posts screen"
    - "User can swipe between For You and Following tabs"
    - "User can tap tab labels to switch between tabs"
    - "Each sub-tab preserves its own scroll position when switching"
    - "For You tab shows all verse posts with infinite scroll"
    - "Following tab shows empty state with CTA when no posts or user is unauthenticated"
    - "Pull-to-refresh works independently on each sub-tab"
    - "Skeleton cards show while each feed is loading"
  artifacts:
    - path: "app/(tabs)/posts.tsx"
      provides: "Dual-tab Posts screen with PagerView swipeable For You and Following feeds"
      min_lines: 200
    - path: "lib/stores/feed-store.ts"
      provides: "Zustand store for feed tab state"
      min_lines: 15
  key_links:
    - from: "app/(tabs)/posts.tsx"
      to: "react-native-pager-view"
      via: "PagerView with 2 pages for For You and Following"
      pattern: "PagerView"
    - from: "app/(tabs)/posts.tsx"
      to: "components/feed/feed-list.tsx"
      via: "FeedList component used in each PagerView page"
      pattern: "FeedList"
    - from: "app/(tabs)/posts.tsx"
      to: "components/feed/feed-skeleton.tsx"
      via: "FeedSkeleton as Suspense fallback"
      pattern: "FeedSkeleton"
    - from: "app/(tabs)/posts.tsx"
      to: "lib/stores/feed-store.ts"
      via: "Zustand store for active tab index"
      pattern: "useFeedStore"
---

<objective>
Convert the existing single-feed Posts screen into a dual-tab feed with swipeable For You and Following sub-tabs using PagerView.

Purpose: Per user decision, the Posts tab must have two nested sub-tabs (For You showing all verse posts, Following showing posts from followed users) with Twitter/X style tab labels and swipe navigation. Each tab has independent scroll position and pagination state.

Output: Rewritten posts.tsx with PagerView dual-tab layout, custom animated tab bar header, and a Zustand store for feed tab state.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-feed-engagement/05-CONTEXT.md
@.planning/phases/05-feed-engagement/05-RESEARCH.md
@.planning/phases/05-feed-engagement/05-01-SUMMARY.md

@app/(tabs)/posts.tsx
@app/(tabs)/_layout.tsx
@components/feed/feed-skeleton.tsx
@components/feed/feed-list.tsx
@hooks/use-colors.ts
@lib/stores/verse-selection-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create feed store and PagerView shell with animated tab bar</name>
  <files>lib/stores/feed-store.ts, app/(tabs)/posts.tsx</files>
  <action>
**Feed Store (lib/stores/feed-store.ts):**

Create a minimal Zustand store for feed tab state:
```typescript
import { create } from 'zustand';

interface FeedStore {
  activeTab: number;  // 0 = For You, 1 = Following
  setActiveTab: (tab: number) => void;
}

export const useFeedStore = create<FeedStore>()((set) => ({
  activeTab: 0,
  setActiveTab: (tab) => set({ activeTab: tab }),
}));
```

**Posts Screen shell (app/(tabs)/posts.tsx):**

Begin rewriting posts.tsx. In this task, set up the structural shell -- the PagerView with two pages and the animated tab bar header. Wire each page to placeholder content (FeedSkeleton as temporary content) so the tab switching works. The actual feed data wiring happens in Task 2.

1. **Custom Tab Bar Header:**
   - Positioned at the top of the screen, below the safe area inset
   - Two tab labels: "For You" and "Following" -- centered horizontally
   - Active tab label: bold text, primary color. Inactive: muted color
   - Animated underline indicator that slides between tabs using `useAnimatedStyle` with `withTiming`
   - Tab labels are `Pressable` -- tapping switches the tab via `pagerViewRef.current?.setPage(index)`
   - No app logo, no header bar -- just the two labels (per user decision: minimal and clean)
   - Background color matches the screen bg, with a subtle bottom border

2. **PagerView Setup:**
   - `PagerView` with `ref` for programmatic page changes
   - `initialPage={useFeedStore.getState().activeTab}` (restore last tab)
   - `onPageSelected` callback: update `useFeedStore` activeTab AND update animated indicator
   - CRITICAL: Guard against setPage -> onPageSelected infinite loop by comparing values before calling setPage
   - Two children pages, each with `style={{ width: '100%', height: '100%' }}` (NOT flex: 1 -- PagerView requirement)
   - Each child needs `collapsable={false}` for Android

3. **Placeholder pages:**
   - Page 0 (For You): Wrap a placeholder `ForYouFeed` component stub in `Suspense` with `FeedSkeleton` as fallback. The stub should just render a `View` with `collapsable={false}` and a text "For You feed loading..." (will be replaced in Task 2).
   - Page 1 (Following): Same pattern with `FollowingFeed` stub.

4. **Define GraphQL fragments and queries** (just the definitions, not the data wiring):
   - For You: Keep the same fragment structure as current posts.tsx but with connection key `"forYouFeed_bibleVersePosts"`
   - Following: Create a separate fragment with connection key `"followingFeed_bibleVersePosts"` (even if it uses the same query for now)
   - Both fragments must select the same fields as the current posts.tsx (id, content, createdAt, likesCount, childPostsCount, likedAt, user{...}, images{...}, poll{...}, verse{...})

Run `npx relay-compiler` after creating the GraphQL fragments to generate types.
  </action>
  <verify>
Run `npx relay-compiler` -- should complete without errors.
Run `npx tsc --noEmit` -- should compile without type errors.
Verify the Posts tab shows two tab labels that can be swiped and tapped, with animated underline.
  </verify>
  <done>
Posts screen has PagerView shell with:
- Animated tab bar with "For You" and "Following" labels
- Swipeable PagerView with two pages
- Tab state persists in Zustand store
- GraphQL fragments defined and Relay types generated
- Placeholder content in each page (ready for Task 2 wiring)
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire For You and Following feeds into PagerView pages</name>
  <files>app/(tabs)/posts.tsx</files>
  <action>
Replace the placeholder stubs from Task 1 with fully functional feed components inside posts.tsx.

1. **For You Feed (Page 0):**
   - Inner component `ForYouFeed` uses `useLazyLoadQuery` + `usePaginationFragment` with the `bibleVersePosts` query
   - Uses connection key `"forYouFeed_bibleVersePosts"` (the fragment defined in Task 1)
   - Renders via `FeedList` component from Plan 01
   - Mutation handlers (like, unlike, delete) with optimistic updates -- same logic as current posts.tsx
   - Pull-to-refresh via `refetch` with `store-and-network` policy
   - Empty state: existing empty card with "No posts yet" message

2. **Following Feed (Page 1):**
   - Inner component `FollowingFeed`:
     - Check if user is authenticated via `useSession()`
     - If NOT authenticated: show empty state with "Sign in to see posts from people you follow" + sign-in button
     - If authenticated: attempt to use a `bibleVersePosts` query with a `following: true` filter parameter
     - IMPORTANT: The backend may not support a "following" filter yet. If the query fails or doesn't exist, show a graceful empty state: "Following feed coming soon"
     - For the optimistic approach: try using the same `bibleVersePosts` query but check if the server supports a filter argument. If not, just show the empty state for now.
   - Following feed empty state (per user decision):
     - Friendly illustration area (use a large Users icon from lucide at 48px in a rounded container with accent background)
     - Text: "Follow people to see their posts here"
     - Button/link: "Discover posts" that switches to For You tab via `pagerViewRef.current?.setPage(0)`

3. **Content insets:**
   - `contentContainerStyle={{ paddingTop: TAB_BAR_HEIGHT + insets.top, paddingBottom: insets.bottom + 100 }}`
   - Tab bar is absolute positioned at the top with a semi-transparent background + blur effect (or solid bg color)

Run `npx relay-compiler` if any GraphQL changes were needed.
  </action>
  <verify>
Run `npx relay-compiler` -- should complete without errors.
Run `npx tsc --noEmit` -- should compile without type errors.
Run `npx expo start` and verify:
- For You tab loads all verse posts with pagination and pull-to-refresh
- Following tab shows appropriate empty state (sign-in prompt or "follow people" CTA)
- Skeleton cards show during initial load (not a spinner)
- Each tab preserves scroll position when switching
  </verify>
  <done>
Posts screen is fully functional with:
- For You tab loads all verse posts with pagination, pull-to-refresh, like/unlike/delete
- Following tab shows appropriate empty state (sign-in prompt or "follow people" CTA)
- Skeleton cards show during initial load (not a spinner)
- Each tab preserves scroll position when switching
- No regression in post interaction features
  </done>
</task>

</tasks>

<verification>
- `npx relay-compiler` passes
- `npx tsc --noEmit` passes
- Posts tab shows "For You" and "Following" labels at top
- Swiping left/right switches between tabs
- Tapping a label switches to that tab
- Animated underline moves with tab selection
- For You tab shows posts with infinite scroll and pull-to-refresh
- Following tab shows empty state with CTA
- Skeleton cards appear during initial load
</verification>

<success_criteria>
- Dual-tab feed is fully navigable via swipe and tap
- For You feed preserves all existing functionality (pagination, like/unlike, delete, pull-to-refresh)
- Following feed shows meaningful empty state with navigation to For You
- No regression in post interaction features
- TypeScript and Relay compilation pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-feed-engagement/05-02-SUMMARY.md`
</output>
