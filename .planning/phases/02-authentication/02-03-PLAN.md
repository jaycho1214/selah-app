---
phase: 02-authentication
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - components/auth/apple-sign-in-button.tsx
autonomous: true

must_haves:
  truths:
    - "User can tap Apple Sign-In button on iOS and see Apple sign-in sheet"
    - "After authenticating, user is signed in with the backend"
    - "Button is hidden on Android (Apple Sign-In is iOS-only)"
  artifacts:
    - path: "components/auth/apple-sign-in-button.tsx"
      provides: "Apple Sign-In button component"
      exports: ["AppleSignInButton"]
  key_links:
    - from: "components/auth/apple-sign-in-button.tsx"
      to: "expo-apple-authentication"
      via: "AppleAuthentication import"
      pattern: "import.*AppleAuthentication.*from.*expo-apple-authentication"
    - from: "components/auth/apple-sign-in-button.tsx"
      to: "lib/auth-client.ts"
      via: "authClient.signIn.social for idToken verification"
      pattern: "authClient\\.signIn\\.social"
---

<objective>
Implement Apple Sign-In flow using Expo SDK with Better Auth idToken verification

Purpose: Enable users to sign in with their Apple accounts (AUTH-02, required for iOS App Store)
Output: Apple Sign-In button component that authenticates via idToken flow
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-authentication/02-RESEARCH.md

# Auth client from Plan 01
@lib/auth-client.ts
@components/providers/session-provider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify expo-apple-authentication is available</name>
  <files>package.json</files>
  <action>
expo-apple-authentication is part of the Expo SDK and should already be available. Verify it's installed:

```bash
npx expo install expo-apple-authentication
```

This command will:
- Install the package if not present
- Or confirm it's already installed at the correct version

**No additional config plugin needed** - expo-apple-authentication is built into the Expo SDK and works automatically with Apple Sign-In capability enabled in EAS Build or Xcode.
  </action>
  <verify>
1. `npm ls expo-apple-authentication` shows package installed
2. Package version matches Expo SDK version constraints
  </verify>
  <done>expo-apple-authentication available for use</done>
</task>

<task type="auto">
  <name>Task 2: Create Apple Sign-In button component</name>
  <files>components/auth/apple-sign-in-button.tsx</files>
  <action>
Create components/auth/apple-sign-in-button.tsx:

```typescript
import { useState, useEffect } from 'react';
import { Alert, Platform, View } from 'react-native';
import * as AppleAuthentication from 'expo-apple-authentication';
import { authClient } from '@/lib/auth-client';

interface AppleSignInButtonProps {
  onSuccess?: () => void;
  onError?: (error: Error) => void;
}

export function AppleSignInButton({ onSuccess, onError }: AppleSignInButtonProps) {
  const [isAvailable, setIsAvailable] = useState(false);
  const [isLoading, setIsLoading] = useState(false);

  useEffect(() => {
    // Apple Sign-In is only available on iOS 13+
    if (Platform.OS === 'ios') {
      AppleAuthentication.isAvailableAsync().then(setIsAvailable);
    }
  }, []);

  // Don't render anything on non-iOS or if unavailable
  if (Platform.OS !== 'ios' || !isAvailable) {
    return null;
  }

  const handlePress = async () => {
    if (isLoading) return;

    setIsLoading(true);
    try {
      // 1. Get credentials from native Apple Sign-In
      const credential = await AppleAuthentication.signInAsync({
        requestedScopes: [
          AppleAuthentication.AppleAuthenticationScope.FULL_NAME,
          AppleAuthentication.AppleAuthenticationScope.EMAIL,
        ],
      });

      if (!credential.identityToken) {
        throw new Error('No identity token received from Apple');
      }

      // 2. Verify identityToken with Better Auth backend
      const result = await authClient.signIn.social({
        provider: 'apple',
        idToken: {
          token: credential.identityToken,
        },
      });

      if (result.error) {
        throw new Error(result.error.message ?? 'Sign-in failed');
      }

      onSuccess?.();
    } catch (error: any) {
      // User cancelled - not an error
      if (error.code === 'ERR_REQUEST_CANCELED') {
        setIsLoading(false);
        return;
      }

      const err = error instanceof Error ? error : new Error('Unknown error');
      onError?.(err);
      Alert.alert('Sign-In Failed', err.message);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <View className="w-full" pointerEvents={isLoading ? 'none' : 'auto'}>
      <AppleAuthentication.AppleAuthenticationButton
        buttonType={AppleAuthentication.AppleAuthenticationButtonType.SIGN_IN}
        buttonStyle={AppleAuthentication.AppleAuthenticationButtonStyle.BLACK}
        cornerRadius={8}
        style={{ width: '100%', height: 48 }}
        onPress={handlePress}
      />
    </View>
  );
}
```

**Key design decisions:**

1. **Platform check:** Only renders on iOS. Returns null on Android/web.

2. **Availability check:** Uses `isAvailableAsync()` to verify iOS 13+ and Sign-In capability.

3. **Native button:** Uses Apple's official `AppleAuthenticationButton` component which:
   - Complies with Apple's Human Interface Guidelines
   - Has required styling (black/white themes)
   - Required for App Store approval

4. **Scopes:** Requests FULL_NAME and EMAIL - Apple provides these only on first sign-in, then caches on device.

5. **Error handling:** Distinguishes user cancellation (ERR_REQUEST_CANCELED) from real errors.

6. **idToken format:** Must be `{ token: identityToken }` object for Better Auth verification.
  </action>
  <verify>
1. File exists at components/auth/apple-sign-in-button.tsx
2. TypeScript compiles: `npx tsc --noEmit`
3. Exports AppleSignInButton
4. Uses AppleAuthenticationButton native component
5. Has Platform.OS check for iOS-only rendering
  </verify>
  <done>Apple Sign-In button component with native UI and idToken verification</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Package installed:**
   ```bash
   npm ls expo-apple-authentication
   ```

2. **TypeScript compiles:**
   ```bash
   npx tsc --noEmit
   ```

3. **Component structure:**
   - Platform check returns null for non-iOS
   - Uses native AppleAuthenticationButton
   - Sends idToken to Better Auth backend

**Testing notes:**
- Apple Sign-In requires a development build (not Expo Go)
- Requires Apple Developer account with Sign-In capability
- Only works on iOS devices/simulators
- On Android, component returns null (expected behavior)
</verification>

<success_criteria>
- expo-apple-authentication installed
- components/auth/apple-sign-in-button.tsx created
- Component only renders on iOS
- Uses native AppleAuthenticationButton (Apple HIG compliant)
- Requests FULL_NAME and EMAIL scopes
- Uses idToken flow with Better Auth
- Handles cancellation gracefully
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-03-SUMMARY.md`
</output>
