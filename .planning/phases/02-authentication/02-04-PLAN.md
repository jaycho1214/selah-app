---
phase: 02-authentication
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - app/sign-in.tsx
  - app/_layout.tsx
  - app/(tabs)/profile.tsx
autonomous: false

must_haves:
  truths:
    - "Unauthenticated user sees sign-in screen with Google and Apple buttons"
    - "After signing in, user is redirected to main app (tabs)"
    - "Authenticated user can sign out and returns to sign-in screen"
    - "Session persists after app restart (user stays logged in)"
  artifacts:
    - path: "app/sign-in.tsx"
      provides: "Sign-in screen with social login buttons"
      min_lines: 30
    - path: "app/_layout.tsx"
      provides: "Root layout with SessionProvider and protected routing"
      contains: "SessionProvider"
    - path: "app/(tabs)/profile.tsx"
      provides: "Profile screen with sign-out button"
      contains: "signOut"
  key_links:
    - from: "app/_layout.tsx"
      to: "components/providers/session-provider.tsx"
      via: "SessionProvider wrapper"
      pattern: "SessionProvider"
    - from: "app/_layout.tsx"
      to: "useSession"
      via: "session-based routing"
      pattern: "useSession.*session"
    - from: "app/(tabs)/profile.tsx"
      to: "useSession"
      via: "signOut function"
      pattern: "signOut"
---

<objective>
Create sign-in screen and implement protected route navigation with session persistence

Purpose: Complete the authentication flow - users sign in, navigate to app, sign out, and maintain session across restarts (AUTH-03, AUTH-04)
Output: Sign-in screen, protected routing, and sign-out functionality
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-authentication/02-RESEARCH.md

# Auth components from Plans 01-03
@lib/auth-client.ts
@components/providers/session-provider.tsx
@components/auth/google-sign-in-button.tsx
@components/auth/apple-sign-in-button.tsx
@lib/google-signin.ts

# Current app structure
@app/_layout.tsx
@app/(tabs)/profile.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sign-in screen</name>
  <files>app/sign-in.tsx</files>
  <action>
Create app/sign-in.tsx as the entry point for unauthenticated users:

```typescript
import { View } from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { Text } from '@/components/ui/text';
import { GoogleSignInButton } from '@/components/auth/google-sign-in-button';
import { AppleSignInButton } from '@/components/auth/apple-sign-in-button';

export default function SignInScreen() {
  return (
    <SafeAreaView className="flex-1 bg-background">
      <View className="flex-1 justify-center px-6">
        {/* Logo / Branding */}
        <View className="items-center mb-12">
          <Text className="text-4xl font-bold text-foreground">Selah</Text>
          <Text className="text-muted-foreground mt-2 text-center">
            Bible reading with community
          </Text>
        </View>

        {/* Sign-in buttons */}
        <View className="gap-4">
          <GoogleSignInButton />
          <AppleSignInButton />
        </View>

        {/* Footer */}
        <View className="mt-8">
          <Text className="text-center text-sm text-muted-foreground">
            By signing in, you agree to our Terms of Service and Privacy Policy
          </Text>
        </View>
      </View>
    </SafeAreaView>
  );
}
```

**Design notes:**
- Clean, minimal design matching selah-web aesthetic
- Centered layout with logo, buttons, and legal footer
- Uses theme colors (bg-background, text-foreground, text-muted-foreground)
- Both buttons stack vertically with gap
- Apple button auto-hides on Android (component behavior)
  </action>
  <verify>
1. File exists at app/sign-in.tsx
2. TypeScript compiles: `npx tsc --noEmit`
3. Imports GoogleSignInButton and AppleSignInButton
4. Uses theme colors for consistent styling
  </verify>
  <done>Sign-in screen with Google and Apple sign-in buttons</done>
</task>

<task type="auto">
  <name>Task 2: Update root layout with SessionProvider and protected routing</name>
  <files>app/_layout.tsx</files>
  <action>
Update app/_layout.tsx to:
1. Add SessionProvider to provider stack
2. Configure Google Sign-In on app startup
3. Implement protected routing based on session state

```typescript
import '../global.css';

import { LogBox } from 'react-native';

// Suppress deprecation warning from dependencies
LogBox.ignoreLogs(['SafeAreaView has been deprecated']);

import {
  ThemeProvider as NavigationThemeProvider,
  DefaultTheme,
  DarkTheme,
} from '@react-navigation/native';
import { Stack, useRouter, useSegments } from 'expo-router';
import { StatusBar } from 'expo-status-bar';
import 'react-native-reanimated';
import { useEffect, useMemo } from 'react';
import { SafeAreaProvider } from 'react-native-safe-area-context';
import { ActivityIndicator, View } from 'react-native';

import { ThemeProvider, useTheme } from '@/components/providers/theme-provider';
import { RelayProvider } from '@/components/providers/relay-provider';
import { SessionProvider, useSession } from '@/components/providers/session-provider';
import { NAV_THEME } from '@/constants/theme';
import { configureGoogleSignIn } from '@/lib/google-signin';

export const unstable_settings = {
  anchor: '(tabs)',
};

// Configure Google Sign-In once on app load
configureGoogleSignIn();

function useProtectedRoute() {
  const { session, isLoading } = useSession();
  const segments = useSegments();
  const router = useRouter();

  useEffect(() => {
    if (isLoading) return;

    const inAuthGroup = segments[0] === 'sign-in';

    if (!session && !inAuthGroup) {
      // Not signed in, redirect to sign-in
      router.replace('/sign-in');
    } else if (session && inAuthGroup) {
      // Signed in, redirect to main app
      router.replace('/(tabs)');
    }
  }, [session, isLoading, segments]);

  return { isLoading };
}

function RootLayoutNav() {
  const { resolvedTheme } = useTheme();
  const { isLoading } = useProtectedRoute();

  // Merge custom colors with default theme (which includes fonts)
  const theme = useMemo(() => {
    const baseTheme = resolvedTheme === 'dark' ? DarkTheme : DefaultTheme;
    return {
      ...baseTheme,
      colors: {
        ...baseTheme.colors,
        ...NAV_THEME[resolvedTheme].colors,
      },
    };
  }, [resolvedTheme]);

  // Show loading indicator while checking auth state
  if (isLoading) {
    return (
      <View className="flex-1 items-center justify-center bg-background">
        <ActivityIndicator size="large" />
      </View>
    );
  }

  return (
    <NavigationThemeProvider value={theme}>
      <Stack>
        <Stack.Screen name="(tabs)" options={{ headerShown: false }} />
        <Stack.Screen name="sign-in" options={{ headerShown: false }} />
        <Stack.Screen
          name="modal"
          options={{ presentation: 'modal', title: 'Modal' }}
        />
      </Stack>
      <StatusBar style={resolvedTheme === 'dark' ? 'light' : 'dark'} />
    </NavigationThemeProvider>
  );
}

export default function RootLayout() {
  return (
    <SafeAreaProvider>
      <RelayProvider>
        <SessionProvider>
          <ThemeProvider>
            <RootLayoutNav />
          </ThemeProvider>
        </SessionProvider>
      </RelayProvider>
    </SafeAreaProvider>
  );
}
```

**Key changes:**
1. **SessionProvider added** - Wraps ThemeProvider, inside RelayProvider
2. **configureGoogleSignIn()** - Called once at module level on app load
3. **useProtectedRoute hook** - Handles auth-based navigation
4. **Loading state** - Shows ActivityIndicator while checking session
5. **sign-in screen** - Added to Stack navigator

**Provider order:** SafeAreaProvider > RelayProvider > SessionProvider > ThemeProvider > NavigationThemeProvider

**Auth flow:**
- On app start, isLoading is true while session is restored from SecureStore
- Once loaded, if no session -> redirect to /sign-in
- If session exists -> stay on current screen or redirect to /(tabs)
- On sign-in success, session updates, triggers redirect to /(tabs)
- On sign-out, session becomes null, triggers redirect to /sign-in
  </action>
  <verify>
1. File updated at app/_layout.tsx
2. TypeScript compiles: `npx tsc --noEmit`
3. SessionProvider wraps app content
4. configureGoogleSignIn called at module level
5. Stack includes sign-in screen
6. useProtectedRoute hook handles navigation
  </verify>
  <done>Root layout with SessionProvider, Google config, and protected routing</done>
</task>

<task type="auto">
  <name>Task 3: Add sign-out to profile screen</name>
  <files>app/(tabs)/profile.tsx</files>
  <action>
Update app/(tabs)/profile.tsx to show user info and sign-out button:

```typescript
import { View } from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { Text } from '@/components/ui/text';
import { Button } from '@/components/ui/button';
import { useSession } from '@/components/providers/session-provider';
import { signOutFromGoogle } from '@/lib/google-signin';

export default function ProfileScreen() {
  const { session, signOut } = useSession();

  const handleSignOut = async () => {
    // Sign out from Google (clears local Google state)
    await signOutFromGoogle();
    // Sign out from Better Auth (clears session)
    await signOut();
  };

  return (
    <SafeAreaView className="flex-1 bg-background">
      <View className="flex-1 p-6">
        {/* User Info */}
        <View className="items-center mb-8">
          <View className="h-20 w-20 rounded-full bg-muted items-center justify-center mb-4">
            <Text className="text-3xl">
              {session?.user?.name?.[0]?.toUpperCase() ?? '?'}
            </Text>
          </View>
          <Text className="text-xl font-semibold text-foreground">
            {session?.user?.name ?? 'Unknown'}
          </Text>
          <Text className="text-muted-foreground">
            {session?.user?.email ?? ''}
          </Text>
        </View>

        {/* Profile content placeholder */}
        <View className="flex-1">
          <Text className="text-center text-muted-foreground">
            Profile content coming in Phase 4
          </Text>
        </View>

        {/* Sign Out Button */}
        <Button
          variant="outline"
          className="w-full"
          onPress={handleSignOut}
        >
          <Text>Sign Out</Text>
        </Button>
      </View>
    </SafeAreaView>
  );
}
```

**Key features:**
- Displays user avatar (first letter of name), name, and email from session
- Sign-out button at bottom of screen
- handleSignOut clears both Google state and Better Auth session
- After signOut, useProtectedRoute in _layout.tsx redirects to /sign-in

**AUTH-04 satisfied:** User can sign out from profile screen and returns to login.
  </action>
  <verify>
1. File updated at app/(tabs)/profile.tsx
2. TypeScript compiles: `npx tsc --noEmit`
3. Uses useSession hook for session data
4. Has sign-out button with handleSignOut
5. Calls both signOutFromGoogle and session signOut
  </verify>
  <done>Profile screen with user info display and sign-out functionality</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **TypeScript compiles:**
   ```bash
   npx tsc --noEmit
   ```

2. **Files created/modified:**
   - app/sign-in.tsx exists
   - app/_layout.tsx updated with SessionProvider
   - app/(tabs)/profile.tsx has sign-out

3. **Manual verification (requires dev build):**
   - Launch app -> redirected to sign-in
   - Sign in with Google or Apple -> redirected to tabs
   - Go to Profile -> see name/email
   - Tap Sign Out -> redirected to sign-in
   - Close and reopen app -> still signed in (session persistence)
</verification>

<success_criteria>
- app/sign-in.tsx with Google and Apple buttons
- app/_layout.tsx with SessionProvider and protected routing
- app/(tabs)/profile.tsx with user info and sign-out
- Unauthenticated users redirected to /sign-in
- Authenticated users can access tabs
- Sign-out works and redirects to /sign-in
- TypeScript compiles without errors
</success_criteria>

<checkpoint type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete authentication flow: sign-in screen, protected routes, session persistence, sign-out</what-built>
  <how-to-verify>
**Requires development build** (not Expo Go) with OAuth credentials configured.

1. **First launch (no session):**
   - Run `npx expo start` or development build
   - Should see sign-in screen with Google and Apple buttons

2. **Sign in flow:**
   - Tap "Continue with Google"
   - Select Google account in picker
   - Should redirect to Home tab

3. **Session persistence:**
   - Close app completely (swipe away)
   - Reopen app
   - Should go directly to Home tab (not sign-in)

4. **Sign out flow:**
   - Navigate to Profile tab
   - Verify name and email displayed
   - Tap "Sign Out"
   - Should redirect to sign-in screen

5. **Apple Sign-In (iOS only):**
   - On iOS device/simulator
   - Tap Apple button
   - Authenticate with Face ID / Touch ID
   - Should redirect to Home tab
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/02-authentication/02-04-SUMMARY.md`
</output>
