---
phase: 02-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/auth-client.ts
  - components/providers/session-provider.tsx
  - metro.config.js
  - package.json
autonomous: true
user_setup:
  - service: google-cloud
    why: "Google Sign-In requires OAuth client configuration"
    env_vars:
      - name: EXPO_PUBLIC_GOOGLE_WEB_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs -> Web client ID"
    dashboard_config:
      - task: "Create OAuth 2.0 credentials for iOS and Android"
        location: "Google Cloud Console -> APIs & Services -> Credentials"

must_haves:
  truths:
    - "Auth client can be imported and used throughout the app"
    - "Session state is available via useSession hook"
    - "Session persists in SecureStore between app restarts"
  artifacts:
    - path: "lib/auth-client.ts"
      provides: "Better Auth client with expoClient plugin"
      exports: ["authClient", "useSession"]
    - path: "components/providers/session-provider.tsx"
      provides: "React context for auth state"
      exports: ["SessionProvider", "useSession"]
    - path: "metro.config.js"
      provides: "Metro config with package exports enabled"
      contains: "unstable_enablePackageExports"
  key_links:
    - from: "lib/auth-client.ts"
      to: "expo-secure-store"
      via: "expoClient storage config"
      pattern: "storage:\\s*SecureStore"
    - from: "components/providers/session-provider.tsx"
      to: "lib/auth-client.ts"
      via: "useSession import"
      pattern: "import.*authClient.*from.*auth-client"
---

<objective>
Set up Better Auth client and session management for Expo app

Purpose: Foundation for all authentication flows - both Google and Apple Sign-In will use this client
Output: Auth client singleton, SessionProvider context, and Metro configuration for Better Auth packages
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-RESEARCH.md

# Phase 1 established providers pattern
@components/providers/relay-provider.tsx
@components/providers/theme-provider.tsx
@app/_layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Better Auth dependencies and configure Metro</name>
  <files>package.json, metro.config.js</files>
  <action>
Install auth dependencies:
```bash
npx expo install expo-secure-store better-auth @better-auth/expo
```

Create or update metro.config.js to enable package exports (required by Better Auth):
```javascript
const { getDefaultConfig } = require('expo/metro-config');

const config = getDefaultConfig(__dirname);

// Required for @better-auth packages which use package exports
config.resolver.unstable_enablePackageExports = true;

module.exports = config;
```

If metro.config.js already exists, add the unstable_enablePackageExports line to the existing config.

**Why this matters:** Better Auth uses modern package exports which Metro doesn't enable by default. Without this, you'll get "Cannot find module" errors.
  </action>
  <verify>
1. `npm ls expo-secure-store better-auth @better-auth/expo` shows all packages installed
2. metro.config.js contains `unstable_enablePackageExports = true`
3. `npx expo start` launches without Metro resolution errors
  </verify>
  <done>Dependencies installed and Metro configured for Better Auth package resolution</done>
</task>

<task type="auto">
  <name>Task 2: Create auth client with expoClient plugin</name>
  <files>lib/auth-client.ts</files>
  <action>
Create lib/auth-client.ts with Better Auth client configured for Expo:

```typescript
import { createAuthClient } from "better-auth/react";
import { expoClient } from "@better-auth/expo/client";
import * as SecureStore from "expo-secure-store";

const API_URL = process.env.EXPO_PUBLIC_API_URL ?? "https://www.selah.kr";

export const authClient = createAuthClient({
  baseURL: API_URL,
  plugins: [
    expoClient({
      scheme: "selah",           // Deep link scheme
      storagePrefix: "selah",    // SecureStore key prefix
      storage: SecureStore,      // Secure token persistence
    }),
  ],
});

// Export typed hooks for use throughout app
export const useSession = authClient.useSession;
```

**Key points:**
- Uses same API URL as Relay (EXPO_PUBLIC_API_URL with selah.kr fallback)
- scheme "selah" matches app.json deep link scheme
- storagePrefix prevents collision with other SecureStore keys
- SecureStore provides encrypted persistence on iOS Keychain / Android Keystore
  </action>
  <verify>
1. File exists at lib/auth-client.ts
2. TypeScript compiles without errors: `npx tsc --noEmit`
3. Exports authClient and useSession
  </verify>
  <done>Auth client configured with expoClient plugin and SecureStore persistence</done>
</task>

<task type="auto">
  <name>Task 3: Create SessionProvider context</name>
  <files>components/providers/session-provider.tsx</files>
  <action>
Create components/providers/session-provider.tsx providing auth context:

```typescript
import { createContext, useContext, PropsWithChildren } from 'react';
import { authClient, useSession as useAuthSession } from '@/lib/auth-client';

type Session = ReturnType<typeof useAuthSession>['data'];

interface SessionContextValue {
  session: Session;
  isLoading: boolean;
  signOut: () => Promise<void>;
}

const SessionContext = createContext<SessionContextValue | null>(null);

export function SessionProvider({ children }: PropsWithChildren) {
  const { data: session, isPending } = useAuthSession();

  const signOut = async () => {
    await authClient.signOut();
  };

  return (
    <SessionContext.Provider
      value={{
        session,
        isLoading: isPending,
        signOut
      }}
    >
      {children}
    </SessionContext.Provider>
  );
}

export function useSession() {
  const context = useContext(SessionContext);
  if (!context) {
    throw new Error('useSession must be used within SessionProvider');
  }
  return context;
}
```

**Pattern follows:**
- Same structure as RelayProvider and ThemeProvider from Phase 1
- Exposes session, isLoading state, and signOut function
- Type-safe context with null check in useSession hook
  </action>
  <verify>
1. File exists at components/providers/session-provider.tsx
2. TypeScript compiles: `npx tsc --noEmit`
3. Exports SessionProvider and useSession
  </verify>
  <done>SessionProvider context created with session state, loading state, and signOut function</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Dependencies installed:**
   ```bash
   npm ls expo-secure-store better-auth @better-auth/expo
   ```
   All three packages should be listed.

2. **Metro config correct:**
   ```bash
   grep -q "unstable_enablePackageExports" metro.config.js && echo "OK"
   ```

3. **TypeScript compiles:**
   ```bash
   npx tsc --noEmit
   ```
   No errors related to auth-client or session-provider.

4. **Imports work:**
   Test that imports resolve correctly by checking the app starts:
   ```bash
   npx expo start --clear
   ```
   (Can exit after confirming no resolution errors)
</verification>

<success_criteria>
- expo-secure-store, better-auth, @better-auth/expo installed
- metro.config.js has unstable_enablePackageExports = true
- lib/auth-client.ts exports authClient and useSession
- components/providers/session-provider.tsx exports SessionProvider and useSession
- TypeScript compiles without errors
- App starts without Metro resolution errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-01-SUMMARY.md`
</output>
