---
phase: 02-authentication
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - lib/google-signin.ts
  - components/auth/google-sign-in-button.tsx
  - app.json
  - package.json
autonomous: true
user_setup:
  - service: google-cloud
    why: "Google Sign-In requires OAuth credentials"
    env_vars:
      - name: EXPO_PUBLIC_GOOGLE_WEB_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs -> Web client"
    dashboard_config:
      - task: "Create iOS OAuth client (type: iOS, bundle ID: kr.selah.selah)"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> Create Credentials -> OAuth client ID"
      - task: "Create Android OAuth client (type: Android, package: kr.selah.selah)"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> Create Credentials -> OAuth client ID"

must_haves:
  truths:
    - "User can tap Google Sign-In button and see Google account picker"
    - "After selecting account, user is authenticated with the backend"
    - "Google Sign-In returns idToken for server verification"
  artifacts:
    - path: "lib/google-signin.ts"
      provides: "Google Sign-In configuration and sign-in function"
      exports: ["configureGoogleSignIn", "signInWithGoogle"]
    - path: "components/auth/google-sign-in-button.tsx"
      provides: "Google Sign-In button component"
      exports: ["GoogleSignInButton"]
    - path: "app.json"
      provides: "Expo config plugin for Google Sign-In"
      contains: "@react-native-google-signin/google-signin"
  key_links:
    - from: "components/auth/google-sign-in-button.tsx"
      to: "lib/google-signin.ts"
      via: "signInWithGoogle import"
      pattern: "import.*signInWithGoogle.*from"
    - from: "components/auth/google-sign-in-button.tsx"
      to: "lib/auth-client.ts"
      via: "authClient.signIn.social for idToken verification"
      pattern: "authClient\\.signIn\\.social"
---

<objective>
Implement Google Sign-In flow using native SDK with Better Auth idToken verification

Purpose: Enable users to sign in with their Google accounts (AUTH-01)
Output: Google Sign-In button component that authenticates via idToken flow
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-authentication/02-RESEARCH.md

# Auth client from Plan 01
@lib/auth-client.ts
@components/providers/session-provider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure Google Sign-In SDK</name>
  <files>package.json, app.json</files>
  <action>
Install the Google Sign-In package:
```bash
npm install @react-native-google-signin/google-signin
```

Update app.json to add the config plugin. Find the "plugins" array and add:
```json
{
  "expo": {
    "plugins": [
      "@react-native-google-signin/google-signin"
    ]
  }
}
```

If plugins array doesn't exist, create it. If it exists with other plugins, add to the existing array.

**Why native SDK:** The native Google Sign-In SDK provides better UX than OAuth redirect flow - native account picker, One-Tap where supported, and no browser context switch.

**Note:** This plugin requires a development build (`npx expo prebuild` or `eas build`). Expo Go will not work with this package.
  </action>
  <verify>
1. `npm ls @react-native-google-signin/google-signin` shows package installed
2. app.json plugins array includes "@react-native-google-signin/google-signin"
  </verify>
  <done>Google Sign-In SDK installed and Expo config plugin added</done>
</task>

<task type="auto">
  <name>Task 2: Create Google Sign-In configuration and helper</name>
  <files>lib/google-signin.ts</files>
  <action>
Create lib/google-signin.ts:

```typescript
import {
  GoogleSignin,
  statusCodes,
  isSuccessResponse,
  isErrorWithCode,
} from '@react-native-google-signin/google-signin';

/**
 * Configure Google Sign-In with web client ID for server verification.
 * Must be called once before any sign-in attempts (e.g., in app startup).
 */
export function configureGoogleSignIn() {
  GoogleSignin.configure({
    webClientId: process.env.EXPO_PUBLIC_GOOGLE_WEB_CLIENT_ID,
    offlineAccess: false, // We only need idToken for server verification
  });
}

/**
 * Sign in with Google and return the idToken for server verification.
 * @returns idToken string if successful, null if cancelled
 * @throws Error if sign-in fails for reasons other than cancellation
 */
export async function signInWithGoogle(): Promise<string | null> {
  try {
    await GoogleSignin.hasPlayServices();
    const response = await GoogleSignin.signIn();

    if (isSuccessResponse(response)) {
      return response.data.idToken ?? null;
    }

    return null;
  } catch (error) {
    if (isErrorWithCode(error)) {
      switch (error.code) {
        case statusCodes.SIGN_IN_CANCELLED:
          // User cancelled - not an error
          return null;
        case statusCodes.IN_PROGRESS:
          // Sign-in already in progress
          return null;
        case statusCodes.PLAY_SERVICES_NOT_AVAILABLE:
          throw new Error('Google Play Services not available');
        default:
          throw error;
      }
    }
    throw error;
  }
}

/**
 * Sign out from Google (client-side only).
 * Call this alongside Better Auth signOut for complete logout.
 */
export async function signOutFromGoogle(): Promise<void> {
  try {
    await GoogleSignin.signOut();
  } catch {
    // Ignore sign-out errors - user may not be signed in with Google
  }
}
```

**Key design decisions:**
- webClientId (not iOS/Android client ID) is used for server-side verification
- offlineAccess false because we only need idToken, not refresh tokens
- Proper error handling distinguishes cancellation from real errors
- signOutFromGoogle exported for use during logout flow
  </action>
  <verify>
1. File exists at lib/google-signin.ts
2. TypeScript compiles: `npx tsc --noEmit`
3. Exports configureGoogleSignIn, signInWithGoogle, signOutFromGoogle
  </verify>
  <done>Google Sign-In helper functions created with proper error handling</done>
</task>

<task type="auto">
  <name>Task 3: Create Google Sign-In button component</name>
  <files>components/auth/google-sign-in-button.tsx</files>
  <action>
Create components/auth directory if needed, then create components/auth/google-sign-in-button.tsx:

```typescript
import { useState } from 'react';
import { Alert, View } from 'react-native';
import { Button } from '@/components/ui/button';
import { Text } from '@/components/ui/text';
import { signInWithGoogle } from '@/lib/google-signin';
import { authClient } from '@/lib/auth-client';

interface GoogleSignInButtonProps {
  onSuccess?: () => void;
  onError?: (error: Error) => void;
}

export function GoogleSignInButton({ onSuccess, onError }: GoogleSignInButtonProps) {
  const [isLoading, setIsLoading] = useState(false);

  const handlePress = async () => {
    if (isLoading) return;

    setIsLoading(true);
    try {
      // 1. Get idToken from native Google Sign-In
      const idToken = await signInWithGoogle();

      if (!idToken) {
        // User cancelled
        setIsLoading(false);
        return;
      }

      // 2. Verify idToken with Better Auth backend
      const result = await authClient.signIn.social({
        provider: 'google',
        idToken: {
          token: idToken,
        },
      });

      if (result.error) {
        throw new Error(result.error.message ?? 'Sign-in failed');
      }

      onSuccess?.();
    } catch (error) {
      const err = error instanceof Error ? error : new Error('Unknown error');
      onError?.(err);
      Alert.alert('Sign-In Failed', err.message);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Button
      variant="outline"
      className="w-full flex-row items-center justify-center gap-3"
      onPress={handlePress}
      disabled={isLoading}
    >
      <GoogleIcon />
      <Text className="font-medium">
        {isLoading ? 'Signing in...' : 'Continue with Google'}
      </Text>
    </Button>
  );
}

// Simple Google "G" icon using View and Text
function GoogleIcon() {
  return (
    <View className="h-5 w-5 items-center justify-center rounded-full bg-white">
      <Text className="text-sm font-bold text-blue-500">G</Text>
    </View>
  );
}
```

**Flow explanation:**
1. User taps button
2. Native Google Sign-In shows account picker
3. User selects account, native SDK returns idToken
4. idToken sent to Better Auth backend for verification
5. Better Auth creates/returns session, stored via expoClient in SecureStore
6. onSuccess callback notifies parent component

**Important:** The idToken must be passed as `{ token: idToken }` object, NOT as string directly. Passing as string triggers OAuth redirect flow instead.
  </action>
  <verify>
1. Directory exists: components/auth/
2. File exists at components/auth/google-sign-in-button.tsx
3. TypeScript compiles: `npx tsc --noEmit`
4. Exports GoogleSignInButton
  </verify>
  <done>Google Sign-In button component with idToken flow and Better Auth integration</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Package installed:**
   ```bash
   npm ls @react-native-google-signin/google-signin
   ```

2. **Config plugin added:**
   ```bash
   grep -q "google-signin" app.json && echo "OK"
   ```

3. **TypeScript compiles:**
   ```bash
   npx tsc --noEmit
   ```

4. **Exports correct:**
   - lib/google-signin.ts exports: configureGoogleSignIn, signInWithGoogle, signOutFromGoogle
   - components/auth/google-sign-in-button.tsx exports: GoogleSignInButton

**Note:** Full testing requires a development build since Google Sign-In uses native modules not available in Expo Go. The component can be rendered but sign-in will fail without a dev build and proper OAuth credentials.
</verification>

<success_criteria>
- @react-native-google-signin/google-signin installed
- app.json contains config plugin
- lib/google-signin.ts with configure, signIn, signOut functions
- components/auth/google-sign-in-button.tsx with GoogleSignInButton component
- Button uses idToken flow (not OAuth redirect)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-02-SUMMARY.md`
</output>
